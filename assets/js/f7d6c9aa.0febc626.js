"use strict";(globalThis.webpackChunkai_matey_docs=globalThis.webpackChunkai_matey_docs||[]).push([[86],{1184:(e,n,t)=>{t.d(n,{R:()=>l,x:()=>a});var i=t(4041);const s={},r=i.createContext(s);function l(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(r.Provider,{value:n},e.children)}},2787:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"guides/architecture/ir-format","title":"Intermediate Representation (IR) Format","description":"The Intermediate Representation (IR) is the universal format that sits between frontend and backend adapters in ai.matey. It normalizes chat requests, responses, and streams in a provider-agnostic way.","source":"@site/docs/guides/architecture/ir-format.md","sourceDirName":"guides/architecture","slug":"/guides/architecture/ir-format","permalink":"/ai.matey/guides/architecture/ir-format","draft":false,"unlisted":false,"editUrl":"https://github.com/johnhenry/ai.matey/tree/main/packages/ai.matey.docs/docs/guides/architecture/ir-format.md","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"sidebar_position":1},"sidebar":"docs","previous":{"title":"Tutorial 04: Building a Chat API","permalink":"/ai.matey/tutorials/beginner/building-chat-api"},"next":{"title":"Testing","permalink":"/ai.matey/guides/testing/"}}');var s=t(1085),r=t(1184);const l={sidebar_position:1},a="Intermediate Representation (IR) Format",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Design Principles",id:"design-principles",level:2},{value:"1. Provider-Agnostic",id:"1-provider-agnostic",level:3},{value:"2. Extensible",id:"2-extensible",level:3},{value:"3. Type-Safe",id:"3-type-safe",level:3},{value:"4. Stream-Friendly",id:"4-stream-friendly",level:3},{value:"5. Semantic Drift Tracking",id:"5-semantic-drift-tracking",level:3},{value:"Message Roles",id:"message-roles",level:2},{value:"Message Content Types",id:"message-content-types",level:2},{value:"Text Content",id:"text-content",level:3},{value:"Image Content",id:"image-content",level:3},{value:"Tool Use Content",id:"tool-use-content",level:3},{value:"Tool Result Content",id:"tool-result-content",level:3},{value:"Request Format",id:"request-format",level:2},{value:"IRChatCompletionRequest",id:"irchatcompletionrequest",level:3},{value:"Response Format",id:"response-format",level:2},{value:"IRChatCompletionResponse",id:"irchatcompletionresponse",level:3},{value:"Streaming Format",id:"streaming-format",level:2},{value:"IRChatCompletionChunk",id:"irchatcompletionchunk",level:3},{value:"Tools &amp; Function Calling",id:"tools--function-calling",level:2},{value:"IRTool Definition",id:"irtool-definition",level:3},{value:"Parameters",id:"parameters",level:2},{value:"Common Parameters",id:"common-parameters",level:3},{value:"Provider Compatibility",id:"provider-compatibility",level:3},{value:"Capabilities",id:"capabilities",level:2},{value:"IRCapabilities",id:"ircapabilities",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"See Also",id:"see-also",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"intermediate-representation-ir-format",children:"Intermediate Representation (IR) Format"})}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.strong,{children:"Intermediate Representation (IR)"})," is the universal format that sits between frontend and backend adapters in ai.matey. It normalizes chat requests, responses, and streams in a provider-agnostic way."]}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"Client (OpenAI format)\n        \u2193\nFrontend Adapter \u2192 IR Format \u2192 Backend Adapter\n                                        \u2193\n                                Provider (Anthropic API)\n"})}),"\n",(0,s.jsx)(n.p,{children:"The IR acts as a translation layer, allowing any client format to work with any backend provider."}),"\n",(0,s.jsx)(n.h2,{id:"design-principles",children:"Design Principles"}),"\n",(0,s.jsx)(n.h3,{id:"1-provider-agnostic",children:"1. Provider-Agnostic"}),"\n",(0,s.jsx)(n.p,{children:"No provider-specific fields in core types. All providers map to the same IR structure."}),"\n",(0,s.jsx)(n.h3,{id:"2-extensible",children:"2. Extensible"}),"\n",(0,s.jsx)(n.p,{children:"Support for metadata and custom fields allows provider-specific data to flow through without breaking compatibility."}),"\n",(0,s.jsx)(n.h3,{id:"3-type-safe",children:"3. Type-Safe"}),"\n",(0,s.jsx)(n.p,{children:"Uses TypeScript discriminated unions for runtime type checking and compile-time safety."}),"\n",(0,s.jsx)(n.h3,{id:"4-stream-friendly",children:"4. Stream-Friendly"}),"\n",(0,s.jsx)(n.p,{children:"First-class support for streaming responses with multiple streaming modes (delta and accumulated)."}),"\n",(0,s.jsx)(n.h3,{id:"5-semantic-drift-tracking",children:"5. Semantic Drift Tracking"}),"\n",(0,s.jsx)(n.p,{children:"Captures transformations and compatibility warnings when converting between formats."}),"\n",(0,s.jsx)(n.h2,{id:"message-roles",children:"Message Roles"}),"\n",(0,s.jsx)(n.p,{children:"The role of a participant in the conversation:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"type MessageRole = 'system' | 'user' | 'assistant' | 'tool';\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Role Mapping Across Providers:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"IR Role"}),(0,s.jsx)(n.th,{children:"OpenAI"}),(0,s.jsx)(n.th,{children:"Anthropic"}),(0,s.jsx)(n.th,{children:"Gemini"}),(0,s.jsx)(n.th,{children:"Ollama"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system"})}),(0,s.jsx)(n.td,{children:"(separate param)"}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"systemInstruction"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"system"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"user"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"user"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"user"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"user"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"user"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assistant"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assistant"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assistant"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"model"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"assistant"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"tool"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"tool"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"tool_result"})}),(0,s.jsx)(n.td,{children:"N/A"}),(0,s.jsx)(n.td,{children:"N/A"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"message-content-types",children:"Message Content Types"}),"\n",(0,s.jsx)(n.h3,{id:"text-content",children:"Text Content"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface TextContent {\n  type: 'text';\n  text: string;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"image-content",children:"Image Content"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ImageContent {\n  type: 'image';\n  source: {\n    type: 'url' | 'base64';\n    url?: string;\n    mediaType?: string;\n    data?: string;\n  };\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"tool-use-content",children:"Tool Use Content"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ToolUseContent {\n  type: 'tool_use';\n  id: string;\n  name: string;\n  input: Record<string, unknown>;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"tool-result-content",children:"Tool Result Content"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface ToolResultContent {\n  type: 'tool_result';\n  toolUseId: string;\n  content: string | TextContent[];\n  isError?: boolean;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"request-format",children:"Request Format"}),"\n",(0,s.jsx)(n.h3,{id:"irchatcompletionrequest",children:"IRChatCompletionRequest"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IRChatCompletionRequest {\n  model: string;\n  messages: IRMessage[];\n  temperature?: number;\n  max_tokens?: number;\n  top_p?: number;\n  stream?: boolean;\n  tools?: IRTool[];\n  // ...additional parameters\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  model: 'gpt-4',\n  messages: [\n    { role: 'system', content: 'You are helpful.' },\n    { role: 'user', content: 'Hello!' }\n  ],\n  temperature: 0.7,\n  max_tokens: 150\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"response-format",children:"Response Format"}),"\n",(0,s.jsx)(n.h3,{id:"irchatcompletionresponse",children:"IRChatCompletionResponse"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IRChatCompletionResponse {\n  id: string;\n  object: 'chat.completion';\n  created: number;\n  model: string;\n  choices: IRChoice[];\n  usage?: IRUsage;\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  id: 'chatcmpl-abc123',\n  object: 'chat.completion',\n  created: 1677858242,\n  model: 'gpt-4',\n  choices: [{\n    index: 0,\n    message: {\n      role: 'assistant',\n      content: 'Hello! How can I help you today?'\n    },\n    finish_reason: 'stop'\n  }],\n  usage: {\n    prompt_tokens: 10,\n    completion_tokens: 9,\n    total_tokens: 19\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"streaming-format",children:"Streaming Format"}),"\n",(0,s.jsx)(n.h3,{id:"irchatcompletionchunk",children:"IRChatCompletionChunk"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IRChatCompletionChunk {\n  id: string;\n  object: 'chat.completion.chunk';\n  created: number;\n  model: string;\n  choices: IRStreamChoice[];\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Streaming Flow:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Chunk 1\n{ choices: [{ delta: { content: 'Hello' } }] }\n\n// Chunk 2\n{ choices: [{ delta: { content: ' there' } }] }\n\n// Final Chunk\n{ choices: [{ delta: {}, finish_reason: 'stop' }] }\n"})}),"\n",(0,s.jsx)(n.h2,{id:"tools--function-calling",children:"Tools & Function Calling"}),"\n",(0,s.jsx)(n.h3,{id:"irtool-definition",children:"IRTool Definition"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IRTool {\n  type: 'function';\n  function: {\n    name: string;\n    description?: string;\n    parameters: {\n      type: 'object';\n      properties: Record<string, unknown>;\n      required?: string[];\n    };\n  };\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Example:"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"{\n  type: 'function',\n  function: {\n    name: 'get_weather',\n    description: 'Get current weather for a location',\n    parameters: {\n      type: 'object',\n      properties: {\n        location: { type: 'string', description: 'City name' },\n        units: { type: 'string', enum: ['celsius', 'fahrenheit'] }\n      },\n      required: ['location']\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"parameters",children:"Parameters"}),"\n",(0,s.jsx)(n.h3,{id:"common-parameters",children:"Common Parameters"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Parameter"}),(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Default"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"temperature"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"0.7"}),(0,s.jsx)(n.td,{children:"Randomness (0-2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max_tokens"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Maximum response length"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"top_p"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"1.0"}),(0,s.jsx)(n.td,{children:"Nucleus sampling"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"top_k"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Top-k sampling"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"stream"})}),(0,s.jsx)(n.td,{children:"boolean"}),(0,s.jsx)(n.td,{children:"false"}),(0,s.jsx)(n.td,{children:"Enable streaming"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"stop"})}),(0,s.jsx)(n.td,{children:"string[]"}),(0,s.jsx)(n.td,{children:"-"}),(0,s.jsx)(n.td,{children:"Stop sequences"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"presence_penalty"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"Presence penalty (-2 to 2)"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"frequency_penalty"})}),(0,s.jsx)(n.td,{children:"number"}),(0,s.jsx)(n.td,{children:"0"}),(0,s.jsx)(n.td,{children:"Frequency penalty (-2 to 2)"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"provider-compatibility",children:"Provider Compatibility"}),"\n",(0,s.jsx)(n.p,{children:"Not all providers support all parameters. The IR format includes all common parameters, and adapters handle unsupported parameters gracefully."}),"\n",(0,s.jsx)(n.h2,{id:"capabilities",children:"Capabilities"}),"\n",(0,s.jsx)(n.h3,{id:"ircapabilities",children:"IRCapabilities"}),"\n",(0,s.jsx)(n.p,{children:"Describes what a provider/backend supports:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"interface IRCapabilities {\n  streaming: boolean;\n  tools: boolean;\n  vision: boolean;\n  json_mode: boolean;\n  max_context_length: number;\n  // ...more capabilities\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Always validate IR objects"})," before passing to adapters"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Use type guards"})," for content types"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Handle missing optional fields"})," gracefully"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Preserve metadata"})," when transforming"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Check capabilities"})," before using advanced features"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/packages/frontend",children:"Frontend Adapters"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/packages/backend",children:"Backend Adapters"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/johnhenry/ai.matey/blob/main/packages/ai.matey.types",children:"Type Definitions"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(o,{...e})}):o(e)}}}]);