"use strict";(globalThis.webpackChunkai_matey_docs=globalThis.webpackChunkai_matey_docs||[]).push([[747],{546:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>d,default:()=>m,frontMatter:()=>a,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"api/middleware","title":"Middleware API","description":"Complete API reference for all built-in middleware and the Middleware interface.","source":"@site/docs/api/middleware.md","sourceDirName":"api","slug":"/api/middleware","permalink":"/ai.matey/api/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/johnhenry/ai.matey/tree/main/packages/ai.matey.docs/docs/api/middleware.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"docs","previous":{"title":"Router API","permalink":"/ai.matey/api/router"},"next":{"title":"Types API","permalink":"/ai.matey/api/types"}}');var t=r(1085),i=r(1184);const a={sidebar_position:3},d="Middleware API",o={},l=[{value:"Middleware Interface",id:"middleware-interface",level:2},{value:"Built-in Middleware",id:"built-in-middleware",level:2},{value:"Logging Middleware",id:"logging-middleware",level:3},{value:"<code>createLoggingMiddleware(options)</code>",id:"createloggingmiddlewareoptions",level:4},{value:"Caching Middleware",id:"caching-middleware",level:3},{value:"<code>createCachingMiddleware(options)</code>",id:"createcachingmiddlewareoptions",level:4},{value:"Retry Middleware",id:"retry-middleware",level:3},{value:"<code>createRetryMiddleware(options)</code>",id:"createretrymiddlewareoptions",level:4},{value:"Transform Middleware",id:"transform-middleware",level:3},{value:"<code>createTransformMiddleware(options)</code>",id:"createtransformmiddlewareoptions",level:4},{value:"Cost Tracking Middleware",id:"cost-tracking-middleware",level:3},{value:"<code>createCostTrackingMiddleware(options)</code>",id:"createcosttrackingmiddlewareoptions",level:4},{value:"OpenTelemetry Middleware",id:"opentelemetry-middleware",level:3},{value:"<code>createOpenTelemetryMiddleware(options)</code>",id:"createopentelemetrymiddlewareoptions",level:4},{value:"Rate Limit Middleware",id:"rate-limit-middleware",level:3},{value:"<code>createRateLimitMiddleware(options)</code>",id:"createratelimitmiddlewareoptions",level:4},{value:"Validation Middleware",id:"validation-middleware",level:3},{value:"<code>createValidationMiddleware(options)</code>",id:"createvalidationmiddlewareoptions",level:4},{value:"Conversation History Middleware",id:"conversation-history-middleware",level:3},{value:"<code>createConversationHistoryMiddleware(options)</code>",id:"createconversationhistorymiddlewareoptions",level:4},{value:"Custom Middleware",id:"custom-middleware",level:2},{value:"Creating Custom Middleware",id:"creating-custom-middleware",level:3},{value:"Middleware with State",id:"middleware-with-state",level:3},{value:"Async Middleware",id:"async-middleware",level:3},{value:"Middleware Order",id:"middleware-order",level:2},{value:"Middleware Composition",id:"middleware-composition",level:2},{value:"Combining Multiple Middleware",id:"combining-multiple-middleware",level:3},{value:"See Also",id:"see-also",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"middleware-api",children:"Middleware API"})}),"\n",(0,t.jsx)(n.p,{children:"Complete API reference for all built-in middleware and the Middleware interface."}),"\n",(0,t.jsx)(n.h2,{id:"middleware-interface",children:"Middleware Interface"}),"\n",(0,t.jsx)(n.p,{children:"All middleware must implement this interface:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface Middleware {\n  /** Middleware name */\n  name: string;\n\n  /** Called before request is sent to backend */\n  onRequest?(request: IRChatCompletionRequest): Promise<IRChatCompletionRequest>;\n\n  /** Called after response is received from backend */\n  onResponse?(response: IRChatCompletionResponse): Promise<IRChatCompletionResponse>;\n\n  /** Called when an error occurs */\n  onError?(error: Error): Promise<Error | void>;\n\n  /** Called for each stream chunk */\n  onStreamChunk?(chunk: IRChatCompletionChunk): Promise<IRChatCompletionChunk>;\n\n  /** Cleanup function called when middleware is removed */\n  cleanup?(): Promise<void>;\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"built-in-middleware",children:"Built-in Middleware"}),"\n",(0,t.jsx)(n.h3,{id:"logging-middleware",children:"Logging Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createloggingmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createLoggingMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Logs requests and responses for debugging and monitoring."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface LoggingMiddlewareOptions {\n  /** Log level: 'debug' | 'info' | 'warn' | 'error' (default: 'info') */\n  level?: string;\n\n  /** Log requests (default: true) */\n  logRequests?: boolean;\n\n  /** Log responses (default: true) */\n  logResponses?: boolean;\n\n  /** Log stream chunks (default: false) */\n  logStreamChunks?: boolean;\n\n  /** Fields to redact from logs (default: ['apiKey', 'authorization']) */\n  redactFields?: string[];\n\n  /** Custom logger (default: console) */\n  logger?: Logger;\n\n  /** Pretty print (default: true) */\n  pretty?: boolean;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createLoggingMiddleware } from 'ai.matey.middleware';\n\nconst logger = createLoggingMiddleware({\n  level: 'info',\n  logRequests: true,\n  logResponses: true,\n  redactFields: ['apiKey', 'authorization', 'password']\n});\n\nbridge.use(logger);\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Output:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[INFO] Request: POST /chat/completions\n[INFO] Model: gpt-4\n[INFO] Messages: 1\n[INFO] Response: 200 OK (1.2s)\n[INFO] Tokens: 50 (cost: $0.0015)\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"caching-middleware",children:"Caching Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createcachingmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createCachingMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Caches responses to reduce API calls and costs."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface CachingMiddlewareOptions {\n  /** Time-to-live in seconds (default: 3600) */\n  ttl?: number;\n\n  /** Maximum cache size (default: 1000) */\n  maxSize?: number;\n\n  /** Storage backend: 'memory' | 'redis' | 'file' (default: 'memory') */\n  storage?: string;\n\n  /** Redis configuration (if storage is 'redis') */\n  redis?: {\n    host: string;\n    port: number;\n    password?: string;\n    db?: number;\n  };\n\n  /** File path (if storage is 'file') */\n  filePath?: string;\n\n  /** Custom cache key function */\n  keyGenerator?: (request: IRChatCompletionRequest) => string;\n\n  /** Enable cache statistics (default: false) */\n  stats?: boolean;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createCachingMiddleware } from 'ai.matey.middleware';\n\nconst cache = createCachingMiddleware({\n  ttl: 3600,           // Cache for 1 hour\n  maxSize: 1000,       // Max 1000 items\n  storage: 'memory',\n  stats: true\n});\n\nbridge.use(cache);\n\n// First request - cache miss\nawait bridge.chat({ model: 'gpt-4', messages: [...] }); // ~1200ms\n\n// Second identical request - cache hit\nawait bridge.chat({ model: 'gpt-4', messages: [...] }); // ~0.5ms \u26a1\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Cache Statistics:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// Get cache stats\nconst stats = cache.getStats();\nconsole.log(stats);\n/*\n{\n  hits: 45,\n  misses: 12,\n  hitRate: 0.789,\n  size: 12,\n  memoryUsage: 2048\n}\n*/\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"retry-middleware",children:"Retry Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createretrymiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createRetryMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Automatically retries failed requests with exponential backoff."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface RetryMiddlewareOptions {\n  /** Maximum retry attempts (default: 3) */\n  maxAttempts?: number;\n\n  /** Initial delay in ms (default: 1000) */\n  initialDelay?: number;\n\n  /** Maximum delay in ms (default: 10000) */\n  maxDelay?: number;\n\n  /** Backoff multiplier (default: 2) */\n  backoffMultiplier?: number;\n\n  /** Errors to retry */\n  retryableErrors?: string[];\n\n  /** HTTP status codes to retry */\n  retryableStatusCodes?: number[];\n\n  /** Custom retry condition */\n  shouldRetry?: (error: Error, attempt: number) => boolean;\n\n  /** Called before each retry */\n  onRetry?: (error: Error, attempt: number, delay: number) => void;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createRetryMiddleware } from 'ai.matey.middleware';\n\nconst retry = createRetryMiddleware({\n  maxAttempts: 3,\n  initialDelay: 1000,\n  maxDelay: 10000,\n  backoffMultiplier: 2,\n  retryableErrors: ['RATE_LIMIT_EXCEEDED', 'TIMEOUT', 'SERVICE_UNAVAILABLE'],\n  onRetry: (error, attempt, delay) => {\n    console.log(`Retry ${attempt}/3 after ${delay}ms: ${error.message}`);\n  }\n});\n\nbridge.use(retry);\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Console output (on failure):"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"[WARN] Request failed: RATE_LIMIT_EXCEEDED\n[INFO] Retry 1/3 after 1000ms\n[INFO] Retry 2/3 after 2000ms\n[INFO] Request succeeded on attempt 3\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"transform-middleware",children:"Transform Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createtransformmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createTransformMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Transforms requests and responses on-the-fly."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface TransformMiddlewareOptions {\n  /** Transform request before sending */\n  transformRequest?: (request: IRChatCompletionRequest) => IRChatCompletionRequest | Promise<IRChatCompletionRequest>;\n\n  /** Transform response after receiving */\n  transformResponse?: (response: IRChatCompletionResponse) => IRChatCompletionResponse | Promise<IRChatCompletionResponse>;\n\n  /** Transform stream chunks */\n  transformChunk?: (chunk: IRChatCompletionChunk) => IRChatCompletionChunk | Promise<IRChatCompletionChunk>;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createTransformMiddleware } from 'ai.matey.middleware';\n\nconst transform = createTransformMiddleware({\n  transformRequest: (request) => {\n    // Add system message to all requests\n    return {\n      ...request,\n      messages: [\n        { role: 'system', content: 'Be concise and helpful.' },\n        ...request.messages\n      ]\n    };\n  },\n  transformResponse: (response) => {\n    // Convert to uppercase\n    return {\n      ...response,\n      choices: response.choices.map(choice => ({\n        ...choice,\n        message: {\n          ...choice.message,\n          content: choice.message.content.toUpperCase()\n        }\n      }))\n    };\n  }\n});\n\nbridge.use(transform);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"cost-tracking-middleware",children:"Cost Tracking Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createcosttrackingmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createCostTrackingMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Tracks API costs and enforces budgets."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface CostTrackingMiddlewareOptions {\n  /** Budget limit in USD (default: Infinity) */\n  budgetLimit?: number;\n\n  /** Alert threshold (0-1, default: 0.9) */\n  alertThreshold?: number;\n\n  /** Pricing per provider */\n  pricing?: {\n    [provider: string]: {\n      inputTokens: number;   // $ per 1K tokens\n      outputTokens: number;  // $ per 1K tokens\n    };\n  };\n\n  /** Called when budget exceeded */\n  onBudgetExceeded?: (current: number, limit: number) => void;\n\n  /** Called when threshold reached */\n  onThresholdReached?: (current: number, limit: number) => void;\n\n  /** Reset interval in ms (default: null - never reset) */\n  resetInterval?: number;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createCostTrackingMiddleware } from 'ai.matey.middleware';\n\nconst costTracker = createCostTrackingMiddleware({\n  budgetLimit: 100,      // $100 budget\n  alertThreshold: 0.9,   // Alert at 90%\n  onBudgetExceeded: (current, limit) => {\n    console.error(`Budget exceeded! $${current.toFixed(2)} / $${limit}`);\n    // Send alert email, Slack message, etc.\n  },\n  onThresholdReached: (current, limit) => {\n    console.warn(`Budget warning: $${current.toFixed(2)} / $${limit}`);\n  }\n});\n\nbridge.use(costTracker);\n\n// Get current cost\nconst stats = costTracker.getStats();\nconsole.log(`Current cost: $${stats.totalCost.toFixed(2)}`);\nconsole.log(`Requests: ${stats.requestCount}`);\nconsole.log(`Average cost per request: $${stats.avgCostPerRequest.toFixed(4)}`);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"opentelemetry-middleware",children:"OpenTelemetry Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createopentelemetrymiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createOpenTelemetryMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Adds distributed tracing with OpenTelemetry."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface OpenTelemetryMiddlewareOptions {\n  /** Service name (default: 'ai.matey') */\n  serviceName?: string;\n\n  /** Tracer provider */\n  tracerProvider?: TracerProvider;\n\n  /** Span attributes to include */\n  attributes?: Record<string, any>;\n\n  /** Record request/response bodies (default: false) */\n  recordBodies?: boolean;\n\n  /** Record token usage (default: true) */\n  recordUsage?: boolean;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createOpenTelemetryMiddleware } from 'ai.matey.middleware';\nimport { NodeTracerProvider } from '@opentelemetry/sdk-trace-node';\n\nconst provider = new NodeTracerProvider();\n\nconst tracing = createOpenTelemetryMiddleware({\n  serviceName: 'my-ai-service',\n  tracerProvider: provider,\n  recordUsage: true\n});\n\nbridge.use(tracing);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"rate-limit-middleware",children:"Rate Limit Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createratelimitmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createRateLimitMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Enforces rate limits on requests."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface RateLimitMiddlewareOptions {\n  /** Maximum requests per window */\n  maxRequests: number;\n\n  /** Time window in ms */\n  windowMs: number;\n\n  /** Strategy: 'fixed-window' | 'sliding-window' | 'token-bucket' */\n  strategy?: string;\n\n  /** Called when rate limit exceeded */\n  onRateLimitExceeded?: (retryAfter: number) => void;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createRateLimitMiddleware } from 'ai.matey.middleware';\n\nconst rateLimit = createRateLimitMiddleware({\n  maxRequests: 60,       // 60 requests\n  windowMs: 60000,       // per minute\n  strategy: 'sliding-window',\n  onRateLimitExceeded: (retryAfter) => {\n    console.log(`Rate limit exceeded. Retry after ${retryAfter}ms`);\n  }\n});\n\nbridge.use(rateLimit);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"validation-middleware",children:"Validation Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createvalidationmiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createValidationMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Validates requests and responses against schemas."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ValidationMiddlewareOptions {\n  /** Request schema (JSON Schema) */\n  requestSchema?: object;\n\n  /** Response schema (JSON Schema) */\n  responseSchema?: object;\n\n  /** Throw error on validation failure (default: true) */\n  strict?: boolean;\n\n  /** Custom validator function */\n  customValidator?: (data: any, schema: any) => boolean;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createValidationMiddleware } from 'ai.matey.middleware';\n\nconst validation = createValidationMiddleware({\n  requestSchema: {\n    type: 'object',\n    properties: {\n      model: { type: 'string', minLength: 1 },\n      messages: {\n        type: 'array',\n        minItems: 1,\n        items: {\n          type: 'object',\n          required: ['role', 'content'],\n          properties: {\n            role: { enum: ['system', 'user', 'assistant'] },\n            content: { type: 'string', minLength: 1 }\n          }\n        }\n      }\n    },\n    required: ['model', 'messages']\n  },\n  strict: true\n});\n\nbridge.use(validation);\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"conversation-history-middleware",children:"Conversation History Middleware"}),"\n",(0,t.jsx)(n.h4,{id:"createconversationhistorymiddlewareoptions",children:(0,t.jsx)(n.code,{children:"createConversationHistoryMiddleware(options)"})}),"\n",(0,t.jsx)(n.p,{children:"Maintains conversation state across requests."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Parameters:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface ConversationHistoryMiddlewareOptions {\n  /** Maximum messages to keep (default: 100) */\n  maxMessages?: number;\n\n  /** Storage: 'memory' | 'redis' | 'database' (default: 'memory') */\n  storage?: string;\n\n  /** Session TTL in seconds (default: 3600) */\n  sessionTtl?: number;\n\n  /** Auto-summarize long conversations (default: false) */\n  autoSummarize?: boolean;\n\n  /** Summarization threshold (default: 50 messages) */\n  summarizeThreshold?: number;\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Returns:"})," ",(0,t.jsx)(n.code,{children:"Middleware"})]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createConversationHistoryMiddleware } from 'ai.matey.middleware';\n\nconst history = createConversationHistoryMiddleware({\n  maxMessages: 100,\n  storage: 'memory',\n  sessionTtl: 3600,\n  autoSummarize: true,\n  summarizeThreshold: 50\n});\n\nbridge.use(history);\n\n// Messages are automatically maintained across requests\nawait bridge.chat({\n  model: 'gpt-4',\n  messages: [{ role: 'user', content: 'Hello' }],\n  sessionId: 'user-123'\n});\n\nawait bridge.chat({\n  model: 'gpt-4',\n  messages: [{ role: 'user', content: 'What did I just say?' }],\n  sessionId: 'user-123'\n});\n// Previous message is automatically included\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"custom-middleware",children:"Custom Middleware"}),"\n",(0,t.jsx)(n.h3,{id:"creating-custom-middleware",children:"Creating Custom Middleware"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { Middleware, IRChatCompletionRequest, IRChatCompletionResponse } from 'ai.matey.types';\n\nfunction createCustomMiddleware(options: CustomOptions): Middleware {\n  return {\n    name: 'custom-middleware',\n\n    async onRequest(request: IRChatCompletionRequest) {\n      // Modify request before sending\n      console.log('Before request:', request.model);\n\n      // Can modify and return request\n      return {\n        ...request,\n        temperature: Math.min(request.temperature || 0.7, 0.9)\n      };\n    },\n\n    async onResponse(response: IRChatCompletionResponse) {\n      // Process response after receiving\n      console.log('After response:', response.usage);\n\n      return response;\n    },\n\n    async onError(error: Error) {\n      // Handle errors\n      console.error('Error occurred:', error.message);\n\n      // Can modify error or return void\n      return error;\n    },\n\n    async onStreamChunk(chunk: IRChatCompletionChunk) {\n      // Process each stream chunk\n      return chunk;\n    },\n\n    async cleanup() {\n      // Cleanup when middleware is removed\n      console.log('Cleaning up...');\n    }\n  };\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"middleware-with-state",children:"Middleware with State"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createStatefulMiddleware() {\n  let requestCount = 0;\n  const startTime = Date.now();\n\n  return {\n    name: 'request-counter',\n\n    async onRequest(request) {\n      requestCount++;\n      console.log(`Request #${requestCount}`);\n      return request;\n    },\n\n    getStats() {\n      return {\n        totalRequests: requestCount,\n        uptime: Date.now() - startTime,\n        avgRequestsPerMinute: (requestCount / ((Date.now() - startTime) / 60000)).toFixed(2)\n      };\n    }\n  };\n}\n\nconst counter = createStatefulMiddleware();\nbridge.use(counter);\n\n// Later\nconsole.log(counter.getStats());\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"async-middleware",children:"Async Middleware"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createAsyncMiddleware() {\n  return {\n    name: 'async-middleware',\n\n    async onRequest(request) {\n      // Async operations\n      const userContext = await fetchUserContext(request.userId);\n\n      return {\n        ...request,\n        messages: [\n          { role: 'system', content: `User context: ${userContext}` },\n          ...request.messages\n        ]\n      };\n    },\n\n    async onResponse(response) {\n      // Async logging\n      await logToDatabase({\n        request: response.id,\n        tokens: response.usage?.total_tokens,\n        timestamp: new Date()\n      });\n\n      return response;\n    }\n  };\n}\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"middleware-order",children:"Middleware Order"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Order matters!"})," Middleware is executed in the order added:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// \u274c Wrong order\nbridge.use(createCachingMiddleware());  // Runs 3rd\nbridge.use(createRetryMiddleware());    // Runs 2nd\nbridge.use(createLoggingMiddleware());  // Runs 1st\n\n// \u2705 Correct order\nbridge.use(createLoggingMiddleware());  // Runs 1st (logs everything)\nbridge.use(createRetryMiddleware());    // Runs 2nd (retries if needed)\nbridge.use(createCachingMiddleware());  // Runs 3rd (caches successful responses)\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Request Flow:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Logging \u2192 logs request"}),"\n",(0,t.jsx)(n.li,{children:"Retry \u2192 sends request (may retry)"}),"\n",(0,t.jsx)(n.li,{children:"Caching \u2192 checks cache, stores response"}),"\n",(0,t.jsx)(n.li,{children:"Backend \u2192 executes request"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Response Flow:"})}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Backend \u2192 returns response"}),"\n",(0,t.jsx)(n.li,{children:"Caching \u2192 stores in cache"}),"\n",(0,t.jsx)(n.li,{children:"Retry \u2192 handles errors"}),"\n",(0,t.jsx)(n.li,{children:"Logging \u2192 logs response"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"middleware-composition",children:"Middleware Composition"}),"\n",(0,t.jsx)(n.h3,{id:"combining-multiple-middleware",children:"Combining Multiple Middleware"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import {\n  createLoggingMiddleware,\n  createRetryMiddleware,\n  createCachingMiddleware,\n  createCostTrackingMiddleware,\n  createValidationMiddleware\n} from 'ai.matey.middleware';\n\nconst bridge = new Bridge(frontend, backend);\n\n// Production middleware stack\nbridge\n  .use(createLoggingMiddleware({ level: 'info' }))\n  .use(createValidationMiddleware({ strict: true }))\n  .use(createRetryMiddleware({ maxAttempts: 3 }))\n  .use(createCachingMiddleware({ ttl: 3600 }))\n  .use(createCostTrackingMiddleware({ budgetLimit: 100 }));\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/api/bridge",children:"Bridge API"})," - Using middleware with Bridge"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/api/router",children:"Router API"})," - Using middleware with Router"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/packages/middleware",children:"Middleware Package"})," - Package documentation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/johnhenry/ai.matey/tree/main/packages/ai.matey.docs/examples/03-middleware",children:"Middleware Examples"})," - Code examples"]}),"\n"]})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},1184:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>d});var s=r(4041);const t={},i=s.createContext(t);function a(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);