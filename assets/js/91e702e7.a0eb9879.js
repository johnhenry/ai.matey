"use strict";(globalThis.webpackChunkai_matey_docs=globalThis.webpackChunkai_matey_docs||[]).push([[8411],{1184:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>d});var i=r(4041);const t={},s=i.createContext(t);function a(e){const n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},8777:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"packages/middleware","title":"ai.matey.middleware","description":"Production-ready middleware for logging, caching, retry logic, cost tracking, and more. Transform your Bridge into a production-grade AI application.","source":"@site/docs/packages/middleware.md","sourceDirName":"packages","slug":"/packages/middleware","permalink":"/ai.matey/packages/middleware","draft":false,"unlisted":false,"editUrl":"https://github.com/johnhenry/ai.matey/tree/main/packages/ai.matey.docs/docs/packages/middleware.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5}}');var t=r(1085),s=r(1184);const a={sidebar_position:5},d="ai.matey.middleware",l={},c=[{value:"Installation",id:"installation",level:2},{value:"Overview",id:"overview",level:2},{value:"Quick Start",id:"quick-start",level:2},{value:"Logging Middleware",id:"logging-middleware",level:2},{value:"Basic Usage",id:"basic-usage",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Examples",id:"examples",level:3},{value:"Basic Logging",id:"basic-logging",level:4},{value:"Redact Sensitive Data",id:"redact-sensitive-data",level:4},{value:"JSON Logging",id:"json-logging",level:4},{value:"Custom Logger",id:"custom-logger",level:4},{value:"Caching Middleware",id:"caching-middleware",level:2},{value:"Basic Usage",id:"basic-usage-1",level:3},{value:"Configuration",id:"configuration-1",level:3},{value:"Examples",id:"examples-1",level:3},{value:"In-Memory Cache",id:"in-memory-cache",level:4},{value:"Redis Cache",id:"redis-cache",level:4},{value:"Custom Cache Key",id:"custom-cache-key",level:4},{value:"Conditional Caching",id:"conditional-caching",level:4},{value:"Retry Middleware",id:"retry-middleware",level:2},{value:"Basic Usage",id:"basic-usage-2",level:3},{value:"Configuration",id:"configuration-2",level:3},{value:"Examples",id:"examples-2",level:3},{value:"Basic Retry",id:"basic-retry",level:4},{value:"Specific Errors Only",id:"specific-errors-only",level:4},{value:"Custom Retry Logic",id:"custom-retry-logic",level:4},{value:"With Jitter",id:"with-jitter",level:4},{value:"Cost Tracking Middleware",id:"cost-tracking-middleware",level:2},{value:"Basic Usage",id:"basic-usage-3",level:3},{value:"Configuration",id:"configuration-3",level:3},{value:"Examples",id:"examples-3",level:3},{value:"Budget Alerts",id:"budget-alerts",level:4},{value:"Custom Pricing",id:"custom-pricing",level:4},{value:"Get Current Cost",id:"get-current-cost",level:4},{value:"Transform Middleware",id:"transform-middleware",level:2},{value:"Basic Usage",id:"basic-usage-4",level:3},{value:"Configuration",id:"configuration-4",level:3},{value:"Examples",id:"examples-4",level:3},{value:"Add System Message",id:"add-system-message",level:4},{value:"Force Temperature",id:"force-temperature",level:4},{value:"Transform Output",id:"transform-output",level:4},{value:"Add Metadata",id:"add-metadata",level:4},{value:"Rate Limiting Middleware",id:"rate-limiting-middleware",level:2},{value:"Basic Usage",id:"basic-usage-5",level:3},{value:"Configuration",id:"configuration-5",level:3},{value:"Examples",id:"examples-5",level:3},{value:"Fixed Window",id:"fixed-window",level:4},{value:"Sliding Window",id:"sliding-window",level:4},{value:"Circuit Breaker Middleware",id:"circuit-breaker-middleware",level:2},{value:"Basic Usage",id:"basic-usage-6",level:3},{value:"Configuration",id:"configuration-6",level:3},{value:"States",id:"states",level:3},{value:"Middleware Composition",id:"middleware-composition",level:2},{value:"Order Matters",id:"order-matters",level:3},{value:"Recommended Order",id:"recommended-order",level:3},{value:"Creating Custom Middleware",id:"creating-custom-middleware",level:2},{value:"Basic Template",id:"basic-template",level:3},{value:"With State",id:"with-state",level:3},{value:"Async Operations",id:"async-operations",level:3},{value:"Conditional Logic",id:"conditional-logic",level:3},{value:"Production Stack",id:"production-stack",level:2},{value:"Best Practices",id:"best-practices",level:2},{value:"See Also",id:"see-also",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"aimateymiddleware",children:"ai.matey.middleware"})}),"\n",(0,t.jsx)(n.p,{children:"Production-ready middleware for logging, caching, retry logic, cost tracking, and more. Transform your Bridge into a production-grade AI application."}),"\n",(0,t.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"npm install ai.matey.middleware\n"})}),"\n",(0,t.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,t.jsx)(n.p,{children:"Middleware intercepts requests and responses as they flow through your Bridge or Router, allowing you to:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Log"})," all requests and responses"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Cache"})," responses to reduce costs"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Retry"})," failed requests automatically"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Track costs"})," and set budgets"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Transform"})," data on-the-fly"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Rate limit"})," to prevent abuse"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"quick-start",children:"Quick Start"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { Bridge } from 'ai.matey.core';\nimport { OpenAIFrontendAdapter } from 'ai.matey.frontend/openai';\nimport { AnthropicBackendAdapter } from 'ai.matey.backend/anthropic';\nimport {\n  createLoggingMiddleware,\n  createCachingMiddleware,\n  createRetryMiddleware\n} from 'ai.matey.middleware';\n\nconst bridge = new Bridge(\n  new OpenAIFrontendAdapter(),\n  new AnthropicBackendAdapter({ apiKey: 'your-key' })\n);\n\n// Add middleware (order matters!)\nbridge.use(createLoggingMiddleware({ level: 'info' }));\nbridge.use(createRetryMiddleware({ maxAttempts: 3 }));\nbridge.use(createCachingMiddleware({ ttl: 3600 }));\n\n// All requests now have logging, retry, and caching!\nconst response = await bridge.chat({\n  model: 'gpt-4',\n  messages: [{ role: 'user', content: 'Hello!' }]\n});\n"})}),"\n",(0,t.jsx)(n.h2,{id:"logging-middleware",children:"Logging Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Track all requests and responses for debugging and monitoring."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createLoggingMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createLoggingMiddleware({\n    level: 'info' // 'debug' | 'info' | 'warn' | 'error'\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface LoggingOptions {\n  level: 'debug' | 'info' | 'warn' | 'error';\n  logRequests?: boolean;        // Log outgoing requests (default: true)\n  logResponses?: boolean;       // Log incoming responses (default: true)\n  logErrors?: boolean;          // Log errors (default: true)\n  redactFields?: string[];      // Fields to redact (e.g., ['apiKey'])\n  includeTimestamps?: boolean;  // Add timestamps (default: true)\n  destination?: 'console' | 'file' | Logger; // Where to log\n  format?: 'text' | 'json';     // Output format\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"basic-logging",children:"Basic Logging"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createLoggingMiddleware({\n    level: 'info',\n    logRequests: true,\n    logResponses: true\n  })\n);\n\n// Output:\n// [INFO] Request: Model=gpt-4, Messages=1, Temperature=0.7\n// [INFO] Response: 200 OK (1234ms), Tokens=50\n"})}),"\n",(0,t.jsx)(n.h4,{id:"redact-sensitive-data",children:"Redact Sensitive Data"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createLoggingMiddleware({\n    level: 'info',\n    redactFields: ['apiKey', 'authorization', 'api_key']\n  })\n);\n\n// API keys will be replaced with [REDACTED]\n"})}),"\n",(0,t.jsx)(n.h4,{id:"json-logging",children:"JSON Logging"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:'bridge.use(\n  createLoggingMiddleware({\n    level: \'info\',\n    format: \'json\'\n  })\n);\n\n// Output:\n// {"level":"info","timestamp":"2024-01-01T00:00:00.000Z","type":"request","model":"gpt-4"}\n'})}),"\n",(0,t.jsx)(n.h4,{id:"custom-logger",children:"Custom Logger"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import winston from 'winston';\n\nconst logger = winston.createLogger({\n  transports: [new winston.transports.File({ filename: 'ai.log' })]\n});\n\nbridge.use(\n  createLoggingMiddleware({\n    level: 'info',\n    destination: logger\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"caching-middleware",children:"Caching Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Cache responses to reduce API costs and latency."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-1",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createCachingMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createCachingMiddleware({\n    ttl: 3600 // Cache for 1 hour (in seconds)\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-1",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface CachingOptions {\n  ttl: number;                  // Time to live in seconds\n  maxSize?: number;             // Max cached items (default: 1000)\n  storage?: 'memory' | 'redis' | 'file' | CacheStorage;\n  keyGenerator?: (request) => string; // Custom cache key\n  shouldCache?: (response) => boolean; // Should this response be cached?\n  connectionString?: string;    // For Redis\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples-1",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"in-memory-cache",children:"In-Memory Cache"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCachingMiddleware({\n    ttl: 3600,        // 1 hour\n    maxSize: 1000,    // Max 1000 items\n    storage: 'memory'\n  })\n);\n\n// First request hits the API\nconst response1 = await bridge.chat({\n  model: 'gpt-4',\n  messages: [{ role: 'user', content: 'What is 2+2?' }]\n});\n\n// Second identical request served from cache (<1ms)\nconst response2 = await bridge.chat({\n  model: 'gpt-4',\n  messages: [{ role: 'user', content: 'What is 2+2?' }]\n});\n"})}),"\n",(0,t.jsx)(n.h4,{id:"redis-cache",children:"Redis Cache"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCachingMiddleware({\n    ttl: 3600,\n    storage: 'redis',\n    connectionString: 'redis://localhost:6379'\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"custom-cache-key",children:"Custom Cache Key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCachingMiddleware({\n    ttl: 3600,\n    keyGenerator: (request) => {\n      // Only cache based on last message\n      const lastMessage = request.messages[request.messages.length - 1];\n      return `chat:${lastMessage.content}`;\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"conditional-caching",children:"Conditional Caching"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCachingMiddleware({\n    ttl: 3600,\n    shouldCache: (response) => {\n      // Only cache if response is successful and not too long\n      return response.usage?.total_tokens < 1000;\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"retry-middleware",children:"Retry Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Automatically retry failed requests with exponential backoff."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-2",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createRetryMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createRetryMiddleware({\n    maxAttempts: 3 // Retry up to 3 times\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-2",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface RetryOptions {\n  maxAttempts: number;          // Max retry attempts (default: 3)\n  initialDelay?: number;        // Initial delay in ms (default: 1000)\n  maxDelay?: number;            // Max delay in ms (default: 10000)\n  backoffMultiplier?: number;   // Backoff multiplier (default: 2)\n  jitter?: boolean;             // Add randomness (default: true)\n  retryableErrors?: string[];   // Which errors to retry\n  shouldRetry?: (error) => boolean; // Custom retry logic\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples-2",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"basic-retry",children:"Basic Retry"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRetryMiddleware({\n    maxAttempts: 3,\n    initialDelay: 1000,    // Wait 1s before first retry\n    maxDelay: 10000,       // Max 10s between retries\n    backoffMultiplier: 2   // Double delay each time (1s, 2s, 4s)\n  })\n);\n\n// If request fails, automatically retries:\n// Attempt 1: Immediate\n// Attempt 2: After 1s\n// Attempt 3: After 2s\n// Attempt 4: After 4s\n"})}),"\n",(0,t.jsx)(n.h4,{id:"specific-errors-only",children:"Specific Errors Only"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRetryMiddleware({\n    maxAttempts: 3,\n    retryableErrors: [\n      'RATE_LIMIT_EXCEEDED',\n      'TIMEOUT',\n      'SERVICE_UNAVAILABLE'\n    ]\n    // Don't retry AUTH_ERROR, INVALID_REQUEST, etc.\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"custom-retry-logic",children:"Custom Retry Logic"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRetryMiddleware({\n    maxAttempts: 5,\n    shouldRetry: (error, attempt) => {\n      // Retry rate limits up to 5 times\n      if (error.code === 'RATE_LIMIT_EXCEEDED') {\n        return attempt < 5;\n      }\n\n      // Retry timeouts up to 2 times\n      if (error.code === 'TIMEOUT') {\n        return attempt < 2;\n      }\n\n      // Don't retry other errors\n      return false;\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"with-jitter",children:"With Jitter"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRetryMiddleware({\n    maxAttempts: 3,\n    jitter: true // Adds \xb125% randomness to prevent thundering herd\n  })\n);\n\n// Delays: 1s\xb1250ms, 2s\xb1500ms, 4s\xb11s\n"})}),"\n",(0,t.jsx)(n.h2,{id:"cost-tracking-middleware",children:"Cost Tracking Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Monitor API costs and set budgets."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-3",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createCostTrackingMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createCostTrackingMiddleware({\n    budgetLimit: 100 // Alert when cost exceeds $100\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-3",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface CostTrackingOptions {\n  budgetLimit?: number;         // Budget limit in dollars\n  alertThreshold?: number;      // Alert at % of budget (default: 0.9)\n  resetInterval?: number;       // Reset period in ms (default: 86400000 = 1 day)\n  onBudgetExceeded?: () => void; // Callback when budget exceeded\n  onThresholdReached?: (used: number, limit: number) => void;\n  pricing?: Record<string, { input: number; output: number }>; // Custom pricing\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples-3",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"budget-alerts",children:"Budget Alerts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCostTrackingMiddleware({\n    budgetLimit: 100,       // $100 daily budget\n    alertThreshold: 0.9,    // Alert at 90%\n    onBudgetExceeded: () => {\n      console.error('\u26a0\ufe0f  Daily budget exceeded!');\n      sendSlackAlert('Budget exceeded!');\n    },\n    onThresholdReached: (used, limit) => {\n      console.warn(`\u26a0\ufe0f  ${used}/${limit} budget used (90%)`);\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"custom-pricing",children:"Custom Pricing"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createCostTrackingMiddleware({\n    pricing: {\n      'gpt-4': { input: 0.03, output: 0.06 }, // per 1K tokens\n      'gpt-3.5-turbo': { input: 0.0005, output: 0.0015 },\n      'claude-3-5-sonnet-20241022': { input: 0.003, output: 0.015 }\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"get-current-cost",children:"Get Current Cost"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"const costTracker = createCostTrackingMiddleware({\n  budgetLimit: 100\n});\n\nbridge.use(costTracker);\n\n// Later\nconsole.log('Current cost:', costTracker.getCurrentCost());\nconsole.log('Remaining budget:', costTracker.getRemainingBudget());\n"})}),"\n",(0,t.jsx)(n.h2,{id:"transform-middleware",children:"Transform Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Modify requests and responses on-the-fly."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-4",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createTransformMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createTransformMiddleware({\n    transformRequest: (request) => {\n      // Modify request before sending\n      return { ...request, temperature: 0.7 };\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-4",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface TransformOptions {\n  transformRequest?: (request: IRChatCompletionRequest) => IRChatCompletionRequest;\n  transformResponse?: (response: IRChatCompletionResponse) => IRChatCompletionResponse;\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples-4",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"add-system-message",children:"Add System Message"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createTransformMiddleware({\n    transformRequest: (request) => ({\n      ...request,\n      messages: [\n        { role: 'system', content: 'Be concise.' },\n        ...request.messages\n      ]\n    })\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"force-temperature",children:"Force Temperature"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createTransformMiddleware({\n    transformRequest: (request) => ({\n      ...request,\n      temperature: 0.7 // Always use 0.7\n    })\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"transform-output",children:"Transform Output"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createTransformMiddleware({\n    transformResponse: (response) => ({\n      ...response,\n      choices: response.choices.map(choice => ({\n        ...choice,\n        message: {\n          ...choice.message,\n          content: choice.message.content.toUpperCase()\n        }\n      }))\n    })\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"add-metadata",children:"Add Metadata"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createTransformMiddleware({\n    transformRequest: (request) => ({\n      ...request,\n      metadata: {\n        user_id: getCurrentUserId(),\n        timestamp: Date.now()\n      }\n    })\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"rate-limiting-middleware",children:"Rate Limiting Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Prevent API abuse with rate limiting."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-5",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createRateLimitMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createRateLimitMiddleware({\n    maxRequests: 100,  // Max 100 requests\n    windowMs: 60000    // Per minute\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-5",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface RateLimitOptions {\n  maxRequests: number;          // Max requests per window\n  windowMs: number;             // Window size in milliseconds\n  strategy?: 'fixed' | 'sliding'; // Window strategy\n  onLimitReached?: () => void;  // Callback when limit reached\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"examples-5",children:"Examples"}),"\n",(0,t.jsx)(n.h4,{id:"fixed-window",children:"Fixed Window"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRateLimitMiddleware({\n    maxRequests: 100,\n    windowMs: 60000,     // 100 requests per minute\n    strategy: 'fixed',\n    onLimitReached: () => {\n      console.warn('Rate limit reached!');\n    }\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h4,{id:"sliding-window",children:"Sliding Window"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(\n  createRateLimitMiddleware({\n    maxRequests: 100,\n    windowMs: 60000,\n    strategy: 'sliding' // More accurate\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h2,{id:"circuit-breaker-middleware",children:"Circuit Breaker Middleware"}),"\n",(0,t.jsx)(n.p,{children:"Stop making requests to failing services."}),"\n",(0,t.jsx)(n.h3,{id:"basic-usage-6",children:"Basic Usage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import { createCircuitBreakerMiddleware } from 'ai.matey.middleware';\n\nbridge.use(\n  createCircuitBreakerMiddleware({\n    threshold: 5,     // Open after 5 failures\n    timeout: 60000    // Try again after 1 minute\n  })\n);\n"})}),"\n",(0,t.jsx)(n.h3,{id:"configuration-6",children:"Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"interface CircuitBreakerOptions {\n  threshold: number;            // Failures before opening\n  timeout: number;              // Time before trying again (ms)\n  resetTimeout?: number;        // Time to fully reset (ms)\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"states",children:"States"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Closed"}),": Normal operation, requests go through"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Open"}),": Service is failing, requests immediately fail"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Half-Open"}),": Testing if service recovered"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"middleware-composition",children:"Middleware Composition"}),"\n",(0,t.jsx)(n.h3,{id:"order-matters",children:"Order Matters"}),"\n",(0,t.jsx)(n.p,{children:"Middleware executes in reverse order (last added runs first):"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"bridge.use(middleware1); // Runs 3rd\nbridge.use(middleware2); // Runs 2nd\nbridge.use(middleware3); // Runs 1st\n\n// Request flow:\n// \u2192 middleware3 \u2192 middleware2 \u2192 middleware1 \u2192 Backend\n// \u2190 middleware3 \u2190 middleware2 \u2190 middleware1 \u2190 Backend\n"})}),"\n",(0,t.jsx)(n.h3,{id:"recommended-order",children:"Recommended Order"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"// 1. Logging (outermost - sees everything)\nbridge.use(createLoggingMiddleware({ level: 'info' }));\n\n// 2. Rate limiting (protect from abuse)\nbridge.use(createRateLimitMiddleware({ maxRequests: 100, windowMs: 60000 }));\n\n// 3. Circuit breaker (stop requests to failing services)\nbridge.use(createCircuitBreakerMiddleware({ threshold: 5, timeout: 60000 }));\n\n// 4. Retry (retry failed requests)\nbridge.use(createRetryMiddleware({ maxAttempts: 3 }));\n\n// 5. Caching (cache successful responses)\nbridge.use(createCachingMiddleware({ ttl: 3600 }));\n\n// 6. Cost tracking (monitor spending)\nbridge.use(createCostTrackingMiddleware({ budgetLimit: 100 }));\n\n// 7. Transform (modify requests/responses)\nbridge.use(createTransformMiddleware({ transformRequest: (req) => req }));\n"})}),"\n",(0,t.jsx)(n.h2,{id:"creating-custom-middleware",children:"Creating Custom Middleware"}),"\n",(0,t.jsx)(n.h3,{id:"basic-template",children:"Basic Template"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createCustomMiddleware(options) {\n  return {\n    name: 'custom',\n    async execute(request, next) {\n      // Before request\n      console.log('Before request');\n\n      // Call next middleware/backend\n      const response = await next(request);\n\n      // After response\n      console.log('After response');\n\n      return response;\n    }\n  };\n}\n\nbridge.use(createCustomMiddleware());\n"})}),"\n",(0,t.jsx)(n.h3,{id:"with-state",children:"With State"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createRequestCounter() {\n  let count = 0;\n\n  return {\n    name: 'request-counter',\n    async execute(request, next) {\n      count++;\n      console.log(`Request #${count}`);\n      return next(request);\n    },\n    getCount: () => count,\n    reset: () => { count = 0; }\n  };\n}\n\nconst counter = createRequestCounter();\nbridge.use(counter);\n\n// Later\nconsole.log('Total requests:', counter.getCount());\n"})}),"\n",(0,t.jsx)(n.h3,{id:"async-operations",children:"Async Operations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createDatabaseLogger() {\n  return {\n    name: 'db-logger',\n    async execute(request, next) {\n      const start = Date.now();\n\n      try {\n        const response = await next(request);\n\n        // Log to database\n        await db.logs.insert({\n          request,\n          response,\n          duration: Date.now() - start,\n          status: 'success'\n        });\n\n        return response;\n      } catch (error) {\n        await db.logs.insert({\n          request,\n          error: error.message,\n          duration: Date.now() - start,\n          status: 'error'\n        });\n\n        throw error;\n      }\n    }\n  };\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"conditional-logic",children:"Conditional Logic"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"function createConditionalCache() {\n  return {\n    name: 'conditional-cache',\n    async execute(request, next) {\n      // Only cache short messages\n      const messageLength = JSON.stringify(request.messages).length;\n\n      if (messageLength < 500) {\n        return cacheMiddleware.execute(request, next);\n      }\n\n      return next(request);\n    }\n  };\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"production-stack",children:"Production Stack"}),"\n",(0,t.jsx)(n.p,{children:"Here's a complete production middleware stack:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",children:"import {\n  createLoggingMiddleware,\n  createRateLimitMiddleware,\n  createCircuitBreakerMiddleware,\n  createRetryMiddleware,\n  createCachingMiddleware,\n  createCostTrackingMiddleware\n} from 'ai.matey.middleware';\n\nfunction createProductionBridge(apiKey) {\n  const bridge = new Bridge(\n    new OpenAIFrontendAdapter(),\n    new AnthropicBackendAdapter({ apiKey })\n  );\n\n  // Production middleware stack\n  bridge.use(createLoggingMiddleware({\n    level: process.env.LOG_LEVEL || 'info',\n    format: 'json',\n    destination: 'file',\n    redactFields: ['apiKey', 'authorization']\n  }));\n\n  bridge.use(createRateLimitMiddleware({\n    maxRequests: 1000,\n    windowMs: 60000,\n    strategy: 'sliding'\n  }));\n\n  bridge.use(createCircuitBreakerMiddleware({\n    threshold: 5,\n    timeout: 60000\n  }));\n\n  bridge.use(createRetryMiddleware({\n    maxAttempts: 3,\n    initialDelay: 1000,\n    backoffMultiplier: 2,\n    jitter: true\n  }));\n\n  bridge.use(createCachingMiddleware({\n    ttl: 3600,\n    storage: 'redis',\n    connectionString: process.env.REDIS_URL\n  }));\n\n  bridge.use(createCostTrackingMiddleware({\n    budgetLimit: parseFloat(process.env.DAILY_BUDGET || '100'),\n    onBudgetExceeded: async () => {\n      await sendAlert('Budget exceeded!');\n    }\n  }));\n\n  return bridge;\n}\n"})}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Order middleware correctly"})," - logging first, caching last"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Redact sensitive data"})," - never log API keys"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Set appropriate TTLs"})," - balance freshness vs cost"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Monitor costs"})," - use cost tracking"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use circuit breakers"})," - prevent cascading failures"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Add jitter to retries"})," - prevent thundering herd"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"see-also",children:"See Also"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/packages/core",children:"Core Package"})," - Bridge and Router"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"/tutorials/beginner/using-middleware",children:"Tutorial: Using Middleware"})," - Step-by-step guide"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/johnhenry/ai.matey/tree/main/packages/ai.matey.docs/examples",children:"Examples on GitHub"})," - View all examples"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}}}]);