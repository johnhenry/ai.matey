# Publishing to npm

This guide covers how to publish ai.matey packages to npm using Changesets.

## Overview

The monorepo uses:
- **npm workspaces** for package management
- **Turbo** for parallel builds
- **Changesets** for versioning and publishing

## Prerequisites

### 1. Login to npm

```bash
npm login
```

You'll be prompted for username, password, and OTP if 2FA is enabled.

### 2. Verify login

```bash
npm whoami
```

### 3. Ensure packages build successfully

```bash
npm run build
```

## Publishing Workflow

### Step 1: Create a Changeset

When you make changes that should be published, create a changeset:

```bash
npm run changeset
```

This interactive CLI will ask:
1. **Which packages changed?** (select with spacebar)
2. **Semver bump type?** (major/minor/patch)
3. **Summary of changes?** (appears in CHANGELOG)

This creates a markdown file in `.changeset/` describing the changes.

**Example changeset file** (`.changeset/happy-dogs-dance.md`):
```markdown
---
"ai.matey.core": minor
"ai.matey.http.core": patch
---

Added new routing capabilities to core and fixed rate limiter bug
```

### Step 2: Version Packages

When ready to release, consume the changesets and update versions:

```bash
npm run version-packages
```

This will:
- Update `package.json` versions for changed packages
- Update internal dependency versions automatically
- Generate/update CHANGELOG.md files
- Delete the consumed changeset files

### Step 3: Commit Version Changes

```bash
git add .
git commit -m "Version packages for release"
git push
```

### Step 4: Publish to npm

```bash
npm run release
```

This runs `turbo run build && changeset publish`, which:
- Rebuilds all packages
- Publishes changed packages to npm
- Creates git tags for each published version

## Pre-Publish Checklist

**Before your first publish, ensure everything is ready:**

### Critical Checks

```bash
# 1. Verify all packages build successfully
npm run build
# Should complete without errors for all 21 packages

# 2. Run all tests
npm test
# All tests should pass

# 3. Run linting
npm run lint
# No errors (warnings acceptable)

# 4. Type check everything
npm run typecheck
# Should complete without type errors

# 5. Verify package names are available on npm
for pkg in ai.matey ai.matey.core ai.matey.types ai.matey.errors ai.matey.utils ai.matey.testing ai.matey.backend ai.matey.backend.browser ai.matey.frontend ai.matey.middleware ai.matey.http.core ai.matey.http ai.matey.react.core ai.matey.react.hooks ai.matey.react.nextjs ai.matey.react.stream ai.matey.wrapper ai.matey.native.apple ai.matey.native.model-runner ai.matey.native.node-llamacpp ai.matey.cli; do
  npm view "$pkg" 2>&1 | grep -q "404" && echo "âœ… $pkg available" || echo "âš ï¸  $pkg already exists"
done

# 6. Check you're logged in to npm
npm whoami
# Should show your npm username

# 7. Verify Git is clean and on main
git status
git branch --show-current
# Should be on 'main' with no uncommitted changes

# 8. Verify CI is passing
# Check GitHub Actions: all workflows should be green

# 9. Check package.json files have correct metadata
# - version fields (should all be 1.0.0 for first publish)
# - author, license, repository URLs
# - homepage points to correct docs

# 10. Dry-run a publish to catch issues early
npm publish --dry-run --workspace=ai.matey.core
# Should succeed without errors
```

### Documentation Checks

- [ ] README.md files exist and are up-to-date for all packages
- [ ] LICENSE files are present
- [ ] package.json has correct homepage/repository URLs
- [ ] CHANGELOG.md will be generated by changesets (don't create manually)
- [ ] Examples in READMEs use correct import paths

### Dependency Checks

```bash
# Verify internal dependencies use "*" version
grep -r '"ai.matey' packages/*/package.json | grep -v '"*"' || echo "âœ… All internal deps use *"

# Check for unintended external dependencies
for pkg in packages/*/package.json; do
  echo "=== $pkg ==="
  jq '.dependencies // {} | keys | .[] | select(startswith("ai.matey") | not)' "$pkg"
done
```

### Build Artifact Checks

```bash
# Verify dist folders exist for all packages after build
find packages/*/dist -type d | wc -l
# Should show 63 (21 packages Ã— 3 formats: esm, cjs, types)

# Verify each package has all three formats
for pkg in packages/*/; do
  pkg_name=$(basename "$pkg")
  if [ -d "$pkg/dist/esm" ] && [ -d "$pkg/dist/cjs" ] && [ -d "$pkg/dist/types" ]; then
    echo "âœ… $pkg_name has all formats"
  else
    echo "âŒ $pkg_name missing formats"
  fi
done
```

## First-Time Publish

For an initial publish of all 21 packages.

### Option A: Using Changesets (Recommended)

```bash
# Create a changeset for all packages
npm run changeset
# Select all packages, choose "patch" or "minor" for initial release

# Version and publish
npm run version-packages
git add . && git commit -m "Initial release"
npm run release
```

### Option B: Manual bulk publish

```bash
# Build everything first
npm run build

# Publish all packages from workspace
npm exec --workspaces -- npm publish --access public
```

### Staggered Rollout (Avoiding Rate Limits)

When publishing many packages for the first time, npm may rate limit you. To avoid this, publish in batches with delays:

**Option 1: Publish by category with delays**

```bash
# Build everything first
npm run build

# Core packages first (these are dependencies)
for pkg in ai.matey.types ai.matey.errors ai.matey.utils ai.matey.testing ai.matey.core ai.matey; do
  npm publish --workspace=$pkg --access public
  sleep 5
done

# Wait before next batch
sleep 30

# Backend and Frontend packages
for pkg in ai.matey.backend ai.matey.backend.browser ai.matey.frontend; do
  npm publish --workspace=$pkg --access public
  sleep 5
done

# Middleware and HTTP
for pkg in ai.matey.middleware ai.matey.http-core ai.matey.http; do
  npm publish --workspace=$pkg --access public
  sleep 5
done

# Wrappers, React, Native, CLI
for pkg in ai.matey.wrapper ai.matey.react.core ai.matey.react.hooks ai.matey.react.nextjs ai.matey.react.stream ai.matey.native.apple ai.matey.native.model-runner ai.matey.native.node-llamacpp ai.matey.cli; do
  npm publish --workspace=$pkg --access public
  sleep 5
done
```

**Option 2: Simple staggered publish script**

Create a file `scripts/staggered-publish.sh`:

```bash
#!/bin/bash
# Staggered publish to avoid npm rate limits

DELAY_BETWEEN_PACKAGES=5  # seconds
DELAY_BETWEEN_BATCHES=60  # seconds
BATCH_SIZE=10

packages=($(npm query .workspace | jq -r '.[].name'))
count=0

for pkg in "${packages[@]}"; do
  echo "Publishing $pkg..."
  npm publish --workspace="$pkg" --access public

  count=$((count + 1))

  if [ $((count % BATCH_SIZE)) -eq 0 ]; then
    echo "Batch complete. Waiting ${DELAY_BETWEEN_BATCHES}s..."
    sleep $DELAY_BETWEEN_BATCHES
  else
    sleep $DELAY_BETWEEN_PACKAGES
  fi
done

echo "Done! Published $count packages."
```

Run with:
```bash
chmod +x scripts/staggered-publish.sh
./scripts/staggered-publish.sh
```

**Option 3: Use npm's built-in retry**

If you get rate limited, npm will show an error with a retry-after time. You can:

```bash
# Retry failed publishes after waiting
npm run release 2>&1 | tee publish.log

# Check which packages failed
grep -i "error" publish.log

# Retry specific packages
npm publish --workspace=ai.matey.backend/openai --access public
```

**Rate limit tips:**
- npm typically allows ~100 publishes per hour for verified accounts
- New accounts may have stricter limits
- Wait 1-2 hours if you hit limits, then resume
- Consider publishing over multiple sessions for very large initial releases

## Configuration

### Changeset Config (`.changeset/config.json`)

```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

Key settings:
- `access: "public"` - Packages publish publicly (required for unscoped packages)
- `updateInternalDependencies: "patch"` - Auto-bumps dependents when dependencies change
- `baseBranch: "main"` - Base branch for version comparisons

## Package Structure

Each package includes:
```
packages/ai.matey.core/
â”œâ”€â”€ src/              # Source TypeScript
â”œâ”€â”€ dist/
â”‚   â”œâ”€â”€ esm/          # ES Modules build
â”‚   â”œâ”€â”€ cjs/          # CommonJS build
â”‚   â””â”€â”€ types/        # TypeScript declarations
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â”œâ”€â”€ CHANGELOG.md      # Auto-generated by changesets
â””â”€â”€ LICENSE
```

The `files` field in `package.json` controls what gets published:
```json
{
  "files": ["dist", "README.md", "CHANGELOG.md", "LICENSE"]
}
```

## Troubleshooting

### Check if package name is available

```bash
npm view ai.matey.core
# 404 = name is available
```

### Dry run publish

```bash
npm publish --dry-run --workspace=ai.matey.core
```

### Inspect what will be published

```bash
npm pack --workspace=ai.matey.core
# Creates a tarball you can extract and inspect
tar -tzf ai.matey.core-1.0.0.tgz
```

### Authentication issues

```bash
# Check current user
npm whoami

# Re-login if needed
npm logout
npm login
```

### Build failures

```bash
# Clean and rebuild
npm run clean
npm run build

# Check specific package
npm run build --workspace=ai.matey.core
```

### Version conflicts

If changesets shows unexpected versions:
```bash
# Reset changeset state
rm .changeset/*.md  # Keep config.json and README.md

# Start fresh
npm run changeset
```

## CI/CD Integration

For automated publishing in CI:

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci
      - run: npm run build

      - name: Create Release PR or Publish
        uses: changesets/action@v1
        with:
          publish: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## Package List

The monorepo contains 21 packages organized by category:

| Category | Packages |
|----------|----------|
| Core | `ai.matey`, `ai.matey.core`, `ai.matey.types`, `ai.matey.errors`, `ai.matey.utils`, `ai.matey.testing` |
| Backends | `ai.matey.backend` (server-side providers), `ai.matey.backend.browser` (browser-native) |
| Frontend | `ai.matey.frontend` (all provider adapters) |
| Middleware | `ai.matey.middleware` (retry, caching, logging, telemetry, etc.) |
| HTTP | `ai.matey.http-core`, `ai.matey.http` (Express, Fastify, Hono, Koa, Node, Deno) |
| React | `ai.matey.react.core`, `ai.matey.react.hooks`, `ai.matey.react.nextjs`, `ai.matey.react.stream` |
| Wrappers | `ai.matey.wrapper` (OpenAI SDK, Anthropic SDK, Chrome AI, Chat) |
| Native | `ai.matey.native.apple`, `ai.matey.native.model-runner`, `ai.matey.native.node-llamacpp` |
| CLI | `ai.matey.cli` |

## Adding New Packages

To add a new package to the monorepo:

### 1. Create Package Directory

```bash
mkdir -p packages/my-new-package/src
```

### 2. Create package.json

```bash
cat > packages/my-new-package/package.json << 'EOF'
{
  "name": "ai.matey.my-new-package",
  "version": "1.0.0",
  "description": "Description of your package",
  "type": "module",
  "main": "./dist/cjs/index.js",
  "module": "./dist/esm/index.js",
  "types": "./dist/types/index.d.ts",
  "exports": {
    ".": {
      "import": {
        "types": "./dist/types/index.d.ts",
        "default": "./dist/esm/index.js"
      },
      "require": {
        "types": "./dist/types/index.d.ts",
        "default": "./dist/cjs/index.js"
      }
    }
  },
  "files": [
    "dist",
    "readme.md",
    "CHANGELOG.md",
    "LICENSE"
  ],
  "scripts": {
    "build": "npm run build:esm && npm run build:cjs && npm run build:types",
    "build:esm": "tsc -p tsconfig.esm.json",
    "build:cjs": "tsc -p tsconfig.cjs.json",
    "build:types": "tsc -p tsconfig.types.json",
    "clean": "rm -rf dist",
    "typecheck": "tsc --noEmit",
    "lint": "eslint src --ext .ts",
    "lint:fix": "eslint src --ext .ts --fix"
  },
  "dependencies": {
    "ai.matey.types": "*"
  },
  "devDependencies": {
    "typescript": "^5.9.3",
    "vitest": "^3.2.4"
  },
  "keywords": ["ai", "llm", "ai-matey"],
  "author": "AI Matey",
  "license": "MIT",
  "homepage": "https://github.com/johnhenry/ai.matey#readme",
  "repository": {
    "type": "git",
    "url": "git+https://github.com/johnhenry/ai.matey.git",
    "directory": "packages/my-new-package"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
EOF
```

### 3. Create TypeScript Configs

```bash
# tsconfig.json (base)
cat > packages/my-new-package/tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "noEmit": true
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules", "dist"]
}
EOF

# tsconfig.esm.json
cat > packages/my-new-package/tsconfig.esm.json << 'EOF'
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "ESNext",
    "outDir": "./dist/esm",
    "noEmit": false,
    "declaration": false
  }
}
EOF

# tsconfig.cjs.json
cat > packages/my-new-package/tsconfig.cjs.json << 'EOF'
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "module": "CommonJS",
    "outDir": "./dist/cjs",
    "noEmit": false,
    "declaration": false
  }
}
EOF

# tsconfig.types.json
cat > packages/my-new-package/tsconfig.types.json << 'EOF'
{
  "extends": "./tsconfig.json",
  "compilerOptions": {
    "outDir": "./dist/types",
    "emitDeclarationOnly": true,
    "noEmit": false
  }
}
EOF
```

### 4. Create Source File

```bash
cat > packages/my-new-package/src/index.ts << 'EOF'
/**
 * My New Package
 *
 * @module
 */

export function hello(): string {
  return 'Hello from my new package!';
}
EOF
```

### 5. Create readme.md

```bash
cat > packages/my-new-package/readme.md << 'EOF'
# ai.matey.my-new-package

Description of your package.

## Installation

```bash
npm install ai.matey.my-new-package
```

## Usage

```typescript
import { hello } from 'ai.matey.my-new-package';

console.log(hello());
```
EOF
```

### 6. Install Dependencies and Build

```bash
# Install workspace dependencies (links the new package)
npm install

# Build to verify everything works
npm run build --workspace=ai.matey.my-new-package
```

### 7. Add to Version Control

```bash
git add packages/my-new-package
git commit -m "Add ai.matey.my-new-package"
```

### Package Naming Conventions

| Type | Naming Pattern | Example |
|------|----------------|---------|
| Backend adapter | `ai.matey.backend.<provider>` | `ai.matey.backend/openai` |
| Frontend adapter | `ai.matey.frontend.<provider>` | `ai.matey.frontend/openai` |
| Middleware | `ai.matey.middleware.<name>` | `ai.matey.middleware` |
| HTTP framework | `ai.matey.http.<framework>` | `ai.matey.http/express` |
| React package | `ai.matey.react.<name>` | `ai.matey.react.hooks` |
| Wrapper | `ai.matey.wrapper.<sdk>` | `ai.matey.wrapper/openai` |
| Native | `ai.matey.native.<name>` | `ai.matey.native.model-runner` |
| Core/Utility | `ai.matey.<name>` | `ai.matey.utils` |

### Internal Dependencies

To depend on other monorepo packages, use `"*"` as the version:

```json
{
  "dependencies": {
    "ai.matey.types": "*",
    "ai.matey.errors": "*"
  }
}
```

Changesets will automatically update these to real versions during publishing.

## Post-Publish Verification

After publishing, it's critical to verify that the rollout went well without breakages. This section provides comprehensive verification steps.

### Quick Verification Checklist

âœ… All packages published to npm
âœ… Package versions match expectations
âœ… Package contents correct (no missing files)
âœ… Installation works in clean environment
âœ… Internal dependencies resolve correctly
âœ… Dual-format exports (ESM/CJS) work
âœ… TypeScript types available
âœ… Documentation links work
âœ… Git tags created

### 1. Verify Packages Published to npm

Check that all 21 packages are available on npm:

```bash
# Create verification script
cat > /tmp/verify-npm-publish.sh << 'EOF'
#!/bin/bash

packages=(
  "ai.matey"
  "ai.matey.core"
  "ai.matey.types"
  "ai.matey.errors"
  "ai.matey.utils"
  "ai.matey.testing"
  "ai.matey.backend"
  "ai.matey.backend.browser"
  "ai.matey.frontend"
  "ai.matey.middleware"
  "ai.matey.http.core"
  "ai.matey.http"
  "ai.matey.react.core"
  "ai.matey.react.hooks"
  "ai.matey.react.nextjs"
  "ai.matey.react.stream"
  "ai.matey.wrapper"
  "ai.matey.native.apple"
  "ai.matey.native.model-runner"
  "ai.matey.native.node-llamacpp"
  "ai.matey.cli"
)

echo "Verifying npm packages..."
echo ""

failed=0
for pkg in "${packages[@]}"; do
  if npm view "$pkg" version > /dev/null 2>&1; then
    version=$(npm view "$pkg" version)
    echo "âœ… $pkg@$version"
  else
    echo "âŒ $pkg - NOT FOUND"
    failed=$((failed + 1))
  fi
done

echo ""
if [ $failed -eq 0 ]; then
  echo "ðŸŽ‰ All packages published successfully!"
else
  echo "âš ï¸  $failed package(s) failed to publish"
  exit 1
fi
EOF

chmod +x /tmp/verify-npm-publish.sh
/tmp/verify-npm-publish.sh
```

### 2. Verify Package Versions

Ensure published versions match your local package.json files:

```bash
# Compare local vs published versions
cat > /tmp/verify-versions.sh << 'EOF'
#!/bin/bash

echo "Comparing local vs npm versions..."
echo ""

for pkg_dir in packages/*; do
  if [ -f "$pkg_dir/package.json" ]; then
    pkg_name=$(jq -r '.name' "$pkg_dir/package.json")
    local_version=$(jq -r '.version' "$pkg_dir/package.json")
    npm_version=$(npm view "$pkg_name" version 2>/dev/null || echo "NOT_FOUND")

    if [ "$local_version" = "$npm_version" ]; then
      echo "âœ… $pkg_name: $local_version = $npm_version"
    else
      echo "âš ï¸  $pkg_name: local=$local_version npm=$npm_version"
    fi
  fi
done
EOF

chmod +x /tmp/verify-versions.sh
/tmp/verify-versions.sh
```

### 3. Verify Package Contents

Inspect what was actually published:

```bash
# Download and inspect a package
mkdir -p /tmp/verify-package
cd /tmp/verify-package

# Example: Verify ai.matey.core
npm pack ai.matey.core
tar -tzf ai.matey.core-*.tgz

# Check for required files
tar -tzf ai.matey.core-*.tgz | grep -E "(dist/esm|dist/cjs|dist/types|package.json|README.md)" || echo "âŒ Missing expected files"

# Cleanup
cd -
rm -rf /tmp/verify-package
```

**Verify all packages have correct structure:**

```bash
cat > /tmp/verify-package-structure.sh << 'EOF'
#!/bin/bash

mkdir -p /tmp/verify-packages
cd /tmp/verify-packages

packages=(ai.matey.core ai.matey.utils ai.matey.backend ai.matey.frontend)

for pkg in "${packages[@]}"; do
  echo "Checking $pkg..."
  npm pack "$pkg" > /dev/null 2>&1

  # Check for required files
  if tar -tzf "$pkg"-*.tgz | grep -q "package/dist/esm"; then
    echo "  âœ… ESM build present"
  else
    echo "  âŒ ESM build missing"
  fi

  if tar -tzf "$pkg"-*.tgz | grep -q "package/dist/cjs"; then
    echo "  âœ… CJS build present"
  else
    echo "  âŒ CJS build missing"
  fi

  if tar -tzf "$pkg"-*.tgz | grep -q "package/dist/types"; then
    echo "  âœ… Types present"
  else
    echo "  âŒ Types missing"
  fi

  echo ""
done

cd -
rm -rf /tmp/verify-packages
EOF

chmod +x /tmp/verify-package-structure.sh
/tmp/verify-package-structure.sh
```

### 4. Test Installation in Clean Environment

**Critical: Test in a completely fresh project to catch dependency issues**

```bash
# Create test project
mkdir -p /tmp/test-ai-matey-install
cd /tmp/test-ai-matey-install

npm init -y
npm install ai.matey ai.matey.core ai.matey.backend ai.matey.frontend

# Verify installation succeeded
if [ -d "node_modules/ai.matey" ]; then
  echo "âœ… Installation successful"
else
  echo "âŒ Installation failed"
  exit 1
fi

# Check package structure in node_modules
ls -la node_modules/ai.matey/dist/
ls -la node_modules/ai.matey.core/dist/

# Cleanup
cd -
rm -rf /tmp/test-ai-matey-install
```

### 5. Verify Internal Dependencies Resolved

Check that internal monorepo dependencies (using `*` version) were correctly replaced with published versions:

```bash
# Check that internal deps were replaced
npm view ai.matey.core dependencies
# Should show real versions like "ai.matey.types": "^1.0.0"
# NOT "ai.matey.types": "*"

# Verify for all core packages
for pkg in ai.matey.core ai.matey.backend ai.matey.frontend ai.matey.middleware; do
  echo "=== $pkg dependencies ==="
  npm view "$pkg" dependencies 2>/dev/null || echo "No dependencies"
  echo ""
done
```

### 6. Test ESM and CJS Imports

**Test ESM (ES Modules):**

```bash
mkdir -p /tmp/test-esm
cd /tmp/test-esm

npm init -y
npm pkg set type="module"
npm install ai.matey.core

cat > test.mjs << 'EOF'
import { Bridge } from 'ai.matey.core';
console.log('âœ… ESM import successful');
console.log('Bridge:', typeof Bridge);
EOF

node test.mjs

cd -
rm -rf /tmp/test-esm
```

**Test CJS (CommonJS):**

```bash
mkdir -p /tmp/test-cjs
cd /tmp/test-cjs

npm init -y
npm install ai.matey.core

cat > test.cjs << 'EOF'
const { Bridge } = require('ai.matey.core');
console.log('âœ… CJS require successful');
console.log('Bridge:', typeof Bridge);
EOF

node test.cjs

cd -
rm -rf /tmp/test-cjs
```

### 7. Verify TypeScript Types

Test that TypeScript declarations work correctly:

```bash
mkdir -p /tmp/test-types
cd /tmp/test-types

npm init -y
npm install -D typescript @types/node
npm install ai.matey.core ai.matey.backend ai.matey.frontend

cat > tsconfig.json << 'EOF'
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true
  }
}
EOF

cat > test.ts << 'EOF'
import { Bridge } from 'ai.matey.core';
import { OpenAIBackendAdapter } from 'ai.matey.backend';
import { OpenAIFrontendAdapter } from 'ai.matey.frontend';

// Should have full type inference
const bridge = new Bridge({
  frontend: new OpenAIFrontendAdapter(),
  backend: new OpenAIBackendAdapter({ apiKey: 'test' })
});

console.log('âœ… Types loaded successfully');
EOF

npx tsc --noEmit

cd -
rm -rf /tmp/test-types
```

### 8. Verify Git Tags Created

Changesets should create git tags for each published version:

```bash
# List recent tags
git tag --sort=-version:refname | head -20

# Verify tag format (should be package@version)
# Example: ai.matey.core@1.0.0

# Check that tags were pushed
git ls-remote --tags origin | tail -20
```

If tags weren't pushed:

```bash
git push --tags
```

### 9. Test Real-World Usage Scenario

Create a minimal working example to ensure everything works together:

```bash
mkdir -p /tmp/test-real-world
cd /tmp/test-real-world

npm init -y
npm install ai.matey

cat > example.mjs << 'EOF'
import { Bridge } from 'ai.matey';

console.log('Creating bridge...');
// This verifies that the main package and its dependencies work
const bridge = new Bridge({
  frontend: { normalizeRequest: (r) => r },
  backend: {
    chat: async () => ({ content: 'test' }),
    supportedFeatures: { chat: true }
  }
});

console.log('âœ… Real-world scenario successful');
console.log('Bridge created:', typeof bridge);
EOF

node example.mjs

cd -
rm -rf /tmp/test-real-world
```

### 10. Verify Documentation Links

Check that npm package pages have correct links:

```bash
# Check package homepage URLs
for pkg in ai.matey.core ai.matey.backend ai.matey.frontend; do
  echo "=== $pkg ==="
  npm view "$pkg" homepage
  npm view "$pkg" repository.url
  echo ""
done

# Manually visit npm pages to verify:
# - https://www.npmjs.com/package/ai.matey.core
# - https://www.npmjs.com/package/ai.matey.backend
# - README renders correctly
# - Links to GitHub repo work
```

### 11. Check Download Stats

After 24 hours, verify packages are being discovered:

```bash
npm view ai.matey.core --json | jq '.time'
# Shows publish time and version history
```

Visit npm stats:
- https://www.npmjs.com/package/ai.matey.core
- Check "Weekly Downloads" section

### 12. Automated Verification Script

**Complete verification script:**

```bash
cat > /tmp/verify-publish-complete.sh << 'EOF'
#!/bin/bash
set -e

echo "ðŸ” AI Matey Publication Verification"
echo "===================================="
echo ""

# 1. Check all packages are published
echo "1ï¸âƒ£  Verifying packages on npm..."
packages=(ai.matey ai.matey.core ai.matey.types ai.matey.errors ai.matey.utils ai.matey.testing ai.matey.backend ai.matey.backend.browser ai.matey.frontend ai.matey.middleware ai.matey.http.core ai.matey.http ai.matey.react.core ai.matey.react.hooks ai.matey.react.nextjs ai.matey.react.stream ai.matey.wrapper ai.matey.native.apple ai.matey.native.model-runner ai.matey.native.node-llamacpp ai.matey.cli)

failed=0
for pkg in "${packages[@]}"; do
  if npm view "$pkg" version > /dev/null 2>&1; then
    echo "  âœ… $pkg"
  else
    echo "  âŒ $pkg"
    failed=$((failed + 1))
  fi
done

if [ $failed -gt 0 ]; then
  echo "âŒ $failed packages not found on npm"
  exit 1
fi
echo ""

# 2. Test ESM import
echo "2ï¸âƒ£  Testing ESM import..."
tmpdir=$(mktemp -d)
cd "$tmpdir"
npm init -y > /dev/null 2>&1
npm pkg set type="module" > /dev/null 2>&1
npm install ai.matey.core > /dev/null 2>&1
echo "import { Bridge } from 'ai.matey.core'; console.log('ESM OK');" > test.mjs
node test.mjs
cd -
rm -rf "$tmpdir"
echo ""

# 3. Test CJS require
echo "3ï¸âƒ£  Testing CJS require..."
tmpdir=$(mktemp -d)
cd "$tmpdir"
npm init -y > /dev/null 2>&1
npm install ai.matey.core > /dev/null 2>&1
echo "const { Bridge } = require('ai.matey.core'); console.log('CJS OK');" > test.cjs
node test.cjs
cd -
rm -rf "$tmpdir"
echo ""

# 4. Test TypeScript types
echo "4ï¸âƒ£  Testing TypeScript types..."
tmpdir=$(mktemp -d)
cd "$tmpdir"
npm init -y > /dev/null 2>&1
npm install -D typescript > /dev/null 2>&1
npm install ai.matey.core > /dev/null 2>&1
echo '{"compilerOptions":{"strict":true}}' > tsconfig.json
echo "import { Bridge } from 'ai.matey.core';" > test.ts
npx tsc --noEmit > /dev/null 2>&1 && echo "  âœ… Types OK" || echo "  âŒ Types failed"
cd -
rm -rf "$tmpdir"
echo ""

echo "âœ… All verification checks passed!"
echo ""
echo "ðŸ“Š Next steps:"
echo "  - Check npm package pages render correctly"
echo "  - Verify git tags were pushed: git ls-remote --tags"
echo "  - Monitor download stats after 24 hours"
echo "  - Test in production environment"
EOF

chmod +x /tmp/verify-publish-complete.sh
/tmp/verify-publish-complete.sh
```

### 13. Rollback Plan

If issues are discovered after publishing:

**Option 1: Deprecate broken version**

```bash
# Deprecate a specific version
npm deprecate ai.matey.core@1.0.0 "Broken release, use 1.0.1 instead"

# Deprecate all versions (severe issues)
npm deprecate ai.matey.core "Package has critical issues, do not use"
```

**Option 2: Publish hotfix**

```bash
# Fix the issue
# Create changeset
npm run changeset
# Select patch version
# Version and publish
npm run version-packages
git add . && git commit -m "Hotfix: description"
npm run release
```

**Option 3: Unpublish (within 72 hours of initial publish)**

```bash
# Only possible within 72 hours and if no one depends on it
npm unpublish ai.matey.core@1.0.0

# Unpublish entire package (use with extreme caution)
npm unpublish ai.matey.core --force
```

### 14. Common Issues and Solutions

**Issue: "Package not found" immediately after publish**

```bash
# npm CDN takes 1-2 minutes to propagate
# Wait and retry:
sleep 120
npm view ai.matey.core
```

**Issue: Internal dependencies still show "*"**

```bash
# Changesets didn't update them - you need to manually update
# Edit package.json to use real versions
# Or ensure changesets versioning ran correctly
npm run version-packages
```

**Issue: Types not working**

```bash
# Check dist/types exists in published package
npm pack ai.matey.core
tar -tzf ai.matey.core-*.tgz | grep types

# Verify package.json exports point to types
npm view ai.matey.core --json | jq '.exports'
```

**Issue: ESM/CJS not working**

```bash
# Check dual-format builds exist
npm pack ai.matey.core
tar -tzf ai.matey.core-*.tgz | grep -E "(dist/esm|dist/cjs)"

# Verify package.json exports
npm view ai.matey.core --json | jq '.exports'
```

**Issue: Git tags not created**

```bash
# Manually create and push tags
git tag ai.matey.core@1.0.0
git push --tags
```

### 15. Success Metrics

After 1 week, evaluate success:

- [ ] All 21 packages have >0 downloads
- [ ] No open issues reporting installation failures
- [ ] Types work in popular editors (VSCode, WebStorm)
- [ ] Works in Node 18, 20, 22+
- [ ] Works in modern browsers (if applicable)
- [ ] Documentation renders correctly on npm
- [ ] Search finds packages (search "ai.matey" on npm)
- [ ] Weekly download trend is positive

## Best Practices

1. **Always create changesets for user-facing changes** - Even small fixes deserve changelog entries

2. **Use semantic versioning correctly**:
   - `patch` - Bug fixes, internal changes
   - `minor` - New features, non-breaking additions
   - `major` - Breaking changes

3. **Write clear changeset summaries** - These become CHANGELOG entries

4. **Test before publishing**:
   ```bash
   npm run build
   npm test
   npm run lint
   ```

5. **Review version changes** - Check `git diff` after `version-packages` before committing

6. **Use lowercase `readme.md`** - For cross-platform consistency

7. **Verify after every publish** - Run the automated verification script

8. **Monitor for 48 hours** - Watch for issues, be ready to hotfix

9. **Never unpublish unless absolutely necessary** - Use deprecation instead
