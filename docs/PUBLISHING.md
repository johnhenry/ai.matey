# Publishing to npm

This guide covers how to publish ai.matey packages to npm using Changesets.

## Overview

The monorepo uses:
- **npm workspaces** for package management
- **Turbo** for parallel builds
- **Changesets** for versioning and publishing

## Prerequisites

### 1. Login to npm

```bash
npm login
```

You'll be prompted for username, password, and OTP if 2FA is enabled.

### 2. Verify login

```bash
npm whoami
```

### 3. Ensure packages build successfully

```bash
npm run build
```

## Publishing Workflow

### Step 1: Create a Changeset

When you make changes that should be published, create a changeset:

```bash
npm run changeset
```

This interactive CLI will ask:
1. **Which packages changed?** (select with spacebar)
2. **Semver bump type?** (major/minor/patch)
3. **Summary of changes?** (appears in CHANGELOG)

This creates a markdown file in `.changeset/` describing the changes.

**Example changeset file** (`.changeset/happy-dogs-dance.md`):
```markdown
---
"ai.matey.core": minor
"ai.matey.http.core": patch
---

Added new routing capabilities to core and fixed rate limiter bug
```

### Step 2: Version Packages

When ready to release, consume the changesets and update versions:

```bash
npm run version-packages
```

This will:
- Update `package.json` versions for changed packages
- Update internal dependency versions automatically
- Generate/update CHANGELOG.md files
- Delete the consumed changeset files

### Step 3: Commit Version Changes

```bash
git add .
git commit -m "Version packages for release"
git push
```

### Step 4: Publish to npm

```bash
npm run release
```

This runs `turbo run build && changeset publish`, which:
- Rebuilds all packages
- Publishes changed packages to npm
- Creates git tags for each published version

## First-Time Publish

For an initial publish of all packages:

### Option A: Using Changesets (Recommended)

```bash
# Create a changeset for all packages
npm run changeset
# Select all packages, choose "patch" or "minor" for initial release

# Version and publish
npm run version-packages
git add . && git commit -m "Initial release"
npm run release
```

### Option B: Manual bulk publish

```bash
# Build everything first
npm run build

# Publish all packages from workspace
npm exec --workspaces -- npm publish --access public
```

## Configuration

### Changeset Config (`.changeset/config.json`)

```json
{
  "$schema": "https://unpkg.com/@changesets/config@3.0.0/schema.json",
  "changelog": "@changesets/cli/changelog",
  "commit": false,
  "fixed": [],
  "linked": [],
  "access": "public",
  "baseBranch": "main",
  "updateInternalDependencies": "patch",
  "ignore": []
}
```

Key settings:
- `access: "public"` - Packages publish publicly (required for unscoped packages)
- `updateInternalDependencies: "patch"` - Auto-bumps dependents when dependencies change
- `baseBranch: "main"` - Base branch for version comparisons

## Package Structure

Each package includes:
```
packages/ai.matey.core/
├── src/              # Source TypeScript
├── dist/
│   ├── esm/          # ES Modules build
│   ├── cjs/          # CommonJS build
│   └── types/        # TypeScript declarations
├── package.json
├── README.md
├── CHANGELOG.md      # Auto-generated by changesets
└── LICENSE
```

The `files` field in `package.json` controls what gets published:
```json
{
  "files": ["dist", "README.md", "CHANGELOG.md", "LICENSE"]
}
```

## Troubleshooting

### Check if package name is available

```bash
npm view ai.matey.core
# 404 = name is available
```

### Dry run publish

```bash
npm publish --dry-run --workspace=ai.matey.core
```

### Inspect what will be published

```bash
npm pack --workspace=ai.matey.core
# Creates a tarball you can extract and inspect
tar -tzf ai.matey.core-1.0.0.tgz
```

### Authentication issues

```bash
# Check current user
npm whoami

# Re-login if needed
npm logout
npm login
```

### Build failures

```bash
# Clean and rebuild
npm run clean
npm run build

# Check specific package
npm run build --workspace=ai.matey.core
```

### Version conflicts

If changesets shows unexpected versions:
```bash
# Reset changeset state
rm .changeset/*.md  # Keep config.json and README.md

# Start fresh
npm run changeset
```

## CI/CD Integration

For automated publishing in CI:

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - run: npm ci
      - run: npm run build

      - name: Create Release PR or Publish
        uses: changesets/action@v1
        with:
          publish: npm run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
```

## Package List

The monorepo contains ~70 packages organized by category:

| Category | Packages |
|----------|----------|
| Core | `ai.matey`, `ai.matey.core`, `ai.matey.types`, `ai.matey.errors`, `ai.matey.utils` |
| Backends | `ai.matey.backend.openai`, `ai.matey.backend.anthropic`, `ai.matey.backend.gemini`, etc. |
| Frontends | `ai.matey.frontend.openai`, `ai.matey.frontend.anthropic`, etc. |
| Middleware | `ai.matey.middleware.retry`, `ai.matey.middleware.caching`, etc. |
| HTTP | `ai.matey.http.core`, `ai.matey.http.express`, `ai.matey.http.fastify`, etc. |
| React | `ai.matey.react.core`, `ai.matey.react.hooks`, `ai.matey.react.nextjs` |
| Wrappers | `ai.matey.wrapper.openai-sdk`, `ai.matey.wrapper.anthropic-sdk` |
| Native | `ai.matey.native.model-runner`, `ai.matey.native.node-llamacpp` |

## Best Practices

1. **Always create changesets for user-facing changes** - Even small fixes deserve changelog entries

2. **Use semantic versioning correctly**:
   - `patch` - Bug fixes, internal changes
   - `minor` - New features, non-breaking additions
   - `major` - Breaking changes

3. **Write clear changeset summaries** - These become CHANGELOG entries

4. **Test before publishing**:
   ```bash
   npm run build
   npm test
   npm run lint
   ```

5. **Review version changes** - Check `git diff` after `version-packages` before committing
