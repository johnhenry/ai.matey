<!DOCTYPE html>
<html>
  <head>
    <title>AI.Matey Playground</title>
    <script type="importmap">
      {
        "imports": {
          "ai.matey/openai": "https://cdn.jsdelivr.net/npm/ai.matey@0.0.1/openai/index.mjs",
          "ai.matey/mock": "https://cdn.jsdelivr.net/npm/ai.matey@0.0.1/mock/index.mjs",
          "ai.matey/mock/polyfill": "https://cdn.jsdelivr.net/npm/ai.matey@0.0.1/mock/polyfill.mjs"
        }
      }
    </script>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      :root {
        --primary-color: #2563eb;
        --secondary-color: #1e40af;
        --background-color: #1a1b1e;
        --text-color: #e5e7eb;
        --border-color: #2d2d2d;
        --sidebar-width: 320px;
        --header-height: 60px;
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background-color: var(--background-color);
        color: var(--text-color);
        height: 100vh;
        display: flex;
        overflow: hidden;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100vh;
        min-width: 0;
        position: relative;
      }

      .right-sidebar {
        width: var(--sidebar-width);
        background-color: var(--background-color);
        border-left: 1px solid var(--border-color);
        padding: var(--spacing-md);
        overflow-y: auto;
        transition: width 0.3s ease, margin-right 0.3s ease;
        flex-shrink: 0;
      }

      .right-sidebar.collapsed {
        width: 0;
        margin-right: calc(-1 * var(--spacing-md));
        overflow: hidden;
      }

      .sidebar-toggle {
        position: absolute;
        right: var(--spacing-md);
        top: 50%;
        transform: translateY(-50%);
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 0 4px 4px 0;
        color: var(--text-color);
        cursor: pointer;
        padding: var(--spacing-md) var(--spacing-xs);
        font-size: 1rem;
        z-index: 10;
        transition: right 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 60px;
      }

      .sidebar-toggle:hover {
        background: #2d2d2d;
      }

      .sidebar-toggle.collapsed {
        right: 0;
      }

      .sidebar-toggle::after {
        content: 'â€º';
        font-size: 1.2rem;
        transition: transform 0.3s ease;
      }

      .sidebar-toggle.collapsed::after {
        transform: rotate(180deg);
      }

      .header {
        height: var(--header-height);
        padding: 0 var(--spacing-md);
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
      }

      .header-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .content-area {
        flex: 1;
        padding: var(--spacing-md);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-md);
        min-height: 0;
      }

      .input-area, .output-area {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        min-height: 0;
      }

      textarea {
        flex: 1;
        resize: none;
        font-family: inherit;
        padding: var(--spacing-md);
        background-color: #2d2d2d;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-color);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .implementation-selector {
        display: flex;
        gap: 1px;
        background: var(--border-color);
        padding: 1px;
        border-radius: 6px;
        margin-bottom: var(--spacing-lg);
      }

      .implementation-selector button {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        border: none;
        background: var(--background-color);
        color: var(--text-color);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .implementation-selector button:first-child {
        border-radius: 6px 0 0 6px;
      }

      .implementation-selector button:last-child {
        border-radius: 0 6px 6px 0;
      }

      .implementation-selector button.active {
        background: var(--primary-color);
      }

      .implementation-selector button:hover:not(.active) {
        background: #3b3b3b;
      }

      .input-group {
        margin-bottom: var(--spacing-md);
      }

      .input-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-size: 0.9rem;
        color: #9ca3af;
      }

      input[type="text"],
      input[type="number"],
      select {
        width: 100%;
        padding: var(--spacing-sm);
        background-color: #2d2d2d;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-color);
        font-size: 0.95rem;
      }

      .output {
        background: #1d1d1d;
        color: #ffffff;
        padding: var(--spacing-md);
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
        font-family: monospace;
        flex: 1;
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .status {
        background: #2d2d2d;
        color: #9ca3af;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: 4px;
        font-size: 0.9rem;
      }

      .status.error {
        background: #471818;
        color: #ef4444;
      }

      .section-title {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: var(--spacing-md);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        padding-left: var(--spacing-lg);
      }

      #run {
        background: var(--primary-color);
        color: white;
        border: none;
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: background-color 0.2s;
      }

      #run:hover {
        background: var(--secondary-color);
      }

      #run:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <div class="header">
        <h1>AI.Matey Playground</h1>
        <div class="header-actions">
          <button id="run">Run</button>
        </div>
      </div>

      <div class="content-area">
        <div class="input-area">
          <textarea id="input" placeholder="Enter your prompt here...">Write a poem about space travel</textarea>
          <div class="status" id="status">Ready</div>
        </div>
        <div class="output-area">
          <pre class="output" id="output">Results will appear here...</pre>
        </div>
      </div>
      <button class="sidebar-toggle" id="sidebar-toggle"></button>
    </div>

    <div class="right-sidebar" id="right-sidebar">
      <div class="implementation-selector">
        <button class="tab-button active" data-impl="mock">Mock AI</button>
        <button class="tab-button" data-impl="ollama">Ollama</button>
        <button class="tab-button" data-impl="window">Window AI</button>
      </div>

      <div class="input-group">
        <label for="api-type">API Type</label>
        <select id="api-type">
          <option value="languageModel">Language Model</option>
          <option value="summarizer">Summarizer</option>
          <option value="writer">Writer</option>
          <option value="rewriter">Rewriter</option>
        </select>
      </div>

      <div id="endpoint-group" class="input-group">
        <label for="endpoint">Endpoint</label>
        <input type="text" id="endpoint" value="http://localhost:11434/v1/chat/completions">
      </div>

      <div id="model-group" class="input-group">
        <label for="model">Model</label>
        <div style="display: flex; gap: var(--spacing-sm);">
          <input type="text" id="model" value="llama3.2:latest" style="flex-grow: 1;">
          <button id="fetch-models" title="Fetch available models">ðŸ”„</button>
        </div>
        <select id="model-list" style="display: none; margin-top: var(--spacing-sm);">
          <option value="">Select a model...</option>
        </select>
      </div>

      <div id="dynamic-controls"></div>
    </div>

    <script type="module">
      import mockAI from "ai.matey/mock";
      import AI from "ai.matey/openai";

      const state = {
        implementation: 'mock',
        instance: null,
      };

      const CONTROLS_BY_TYPE = {
        languageModel: [
          { id: 'context', type: 'text', label: 'System Prompt', value: 'You are an expert assistant.' },
          { id: 'temperature', type: 'number', label: 'Temperature', value: 0.7, min: 0, max: 1, step: 0.1 },
          { id: 'topK', type: 'number', label: 'Top K', value: 1, min: 1, step: 1 },
          { id: 'maxTokens', type: 'number', label: 'Max Tokens', value: 200, min: 1 }
        ],
        summarizer: [
          { id: 'type', type: 'select', label: 'Summary Type', options: [
            { value: 'headline', label: 'Headline' },
            { value: 'tl;dr', label: 'TL;DR' },
            { value: 'bullet-points', label: 'Bullet Points' }
          ]},
          { id: 'length', type: 'select', label: 'Length', options: [
            { value: 'short', label: 'Short' },
            { value: 'medium', label: 'Medium' },
            { value: 'long', label: 'Long' }
          ]},
          { id: 'maxTokens', type: 'number', label: 'Max Tokens', value: 200, min: 1 }
        ],
        writer: [
          { id: 'tone', type: 'select', label: 'Tone', options: [
            { value: 'formal', label: 'Formal' },
            { value: 'casual', label: 'Casual' },
            { value: 'neutral', label: 'Neutral' }
          ]},
          { id: 'length', type: 'select', label: 'Length', options: [
            { value: 'short', label: 'Short' },
            { value: 'medium', label: 'Medium' },
            { value: 'long', label: 'Long' }
          ]},
          { id: 'temperature', type: 'number', label: 'Temperature', value: 0.7, min: 0, max: 1, step: 0.1 },
          { id: 'maxTokens', type: 'number', label: 'Max Tokens', value: 200, min: 1 }
        ],
        rewriter: [
          { id: 'tone', type: 'select', label: 'Tone', options: [
            { value: 'formal', label: 'Formal' },
            { value: 'casual', label: 'Casual' },
            { value: 'neutral', label: 'Neutral' }
          ]},
          { id: 'format', type: 'select', label: 'Format', options: [
            { value: 'as-is', label: 'As Is' },
            { value: 'plain-text', label: 'Plain Text' },
            { value: 'markdown', label: 'Markdown' }
          ]},
          { id: 'length', type: 'select', label: 'Length', options: [
            { value: 'as-is', label: 'As Is' },
            { value: 'shorter', label: 'Shorter' },
            { value: 'longer', label: 'Longer' }
          ]}
        ]
      };

      // UI Elements
      const elements = {
        implButtons: document.querySelectorAll('.tab-button'),
        apiType: document.getElementById('api-type'),
        endpoint: document.getElementById('endpoint'),
        endpointGroup: document.getElementById('endpoint-group'),
        model: document.getElementById('model'),
        modelGroup: document.getElementById('model-group'),
        modelList: document.getElementById('model-list'),
        fetchModels: document.getElementById('fetch-models'),
        dynamicControls: document.getElementById('dynamic-controls'),
        input: document.getElementById('input'),
        output: document.getElementById('output'),
        status: document.getElementById('status'),
        runButton: document.getElementById('run')
      };

      function updateDynamicControls(type) {
        const controls = CONTROLS_BY_TYPE[type];
        elements.dynamicControls.innerHTML = '';
        
        controls.forEach(control => {
          const group = document.createElement('div');
          group.className = 'input-group';
          
          const label = document.createElement('label');
          label.htmlFor = control.id;
          label.textContent = control.label;
          group.appendChild(label);
          
          if (control.type === 'select') {
            const select = document.createElement('select');
            select.id = control.id;
            control.options.forEach(opt => {
              const option = document.createElement('option');
              option.value = opt.value;
              option.textContent = opt.label;
              select.appendChild(option);
            });
            group.appendChild(select);
          } else {
            const input = document.createElement('input');
            input.type = control.type;
            input.id = control.id;
            if (control.value !== undefined) input.value = control.value;
            if (control.min !== undefined) input.min = control.min;
            if (control.max !== undefined) input.max = control.max;
            if (control.step !== undefined) input.step = control.step;
            group.appendChild(input);
          }
          
          elements.dynamicControls.appendChild(group);
        });
      }

      // Update controls when API type changes
      elements.apiType.addEventListener('change', () => {
        updateDynamicControls(elements.apiType.value);
      });

      // Implementation switching
      elements.implButtons.forEach(button => {
        button.addEventListener('click', () => {
          elements.implButtons.forEach(b => b.classList.remove('active'));
          button.classList.add('active');
          state.implementation = button.dataset.impl;
          
          // Show/hide endpoint and model inputs for Ollama
          const showOllama = state.implementation === 'ollama';
          elements.endpointGroup.style.display = showOllama ? 'block' : 'none';
          elements.modelGroup.style.display = showOllama ? 'block' : 'none';
        });
      });

      // Initialize dynamic controls
      updateDynamicControls(elements.apiType.value);

      // Helper to get current settings
      function getSettings() {
        const type = elements.apiType.value;
        const settings = {};
        
        CONTROLS_BY_TYPE[type].forEach(control => {
          const element = document.getElementById(control.id);
          if (element) {
            let value = element.value;
            if (control.type === 'number') {
              value = control.step === 1 ? parseInt(value) : parseFloat(value);
            }
            settings[control.id] = value;
          }
        });
        
        return settings;
      }

      // Helper to create AI instance
      async function createInstance(type) {
        let ai;
        
        if (state.implementation === 'mock') {
          ai = mockAI;
        } else if (state.implementation === 'ollama') {
          ai = new AI({
            endpoint: elements.endpoint.value,
            credentials: { apiKey: '123' },
            model: elements.model.value,
          });
        } else {
          ai = window.ai;
        }

        const settings = getSettings();
        
        switch (type) {
          case 'languageModel':
            return ai.languageModel.create({
              context: settings.context,
              temperature: settings.temperature,
              topK: settings.topK,
              maxTokens: settings.maxTokens,
            });
          case 'summarizer':
            return ai.summarizer.create({
              context: settings.context,
              maxTokens: settings.maxTokens,
            });
          case 'writer':
            return ai.writer.create({
              context: settings.context,
              temperature: settings.temperature,
              maxTokens: settings.maxTokens,
            });
          case 'rewriter':
            return ai.rewriter.create({
              tone: settings.tone,
            });
        }
      }

      // Run button handler
      elements.runButton.addEventListener('click', async () => {
        try {
          elements.status.textContent = 'Processing...';
          elements.status.classList.remove('error');
          elements.runButton.disabled = true;

          // Cleanup previous instance
          if (state.instance) {
            state.instance.destroy();
          }

          // Create new instance
          const type = elements.apiType.value;
          state.instance = await createInstance(type);

          // Run the appropriate method
          let result;
          switch (type) {
            case 'languageModel':
              result = await state.instance.prompt(elements.input.value);
              break;
            case 'summarizer':
              result = await state.instance.summarize(elements.input.value);
              break;
            case 'writer':
              result = await state.instance.write(elements.input.value);
              break;
            case 'rewriter':
              result = await state.instance.rewrite(elements.input.value);
              break;
          }

          elements.output.textContent = result;
          elements.status.textContent = 'Complete';
        } catch (error) {
          elements.status.textContent = `Error: ${error.message}`;
          elements.status.classList.add('error');
          elements.output.textContent = '';
        } finally {
          elements.runButton.disabled = false;
        }
      });

      // Fetch models button handler
      elements.fetchModels.addEventListener('click', async () => {
        try {
          elements.fetchModels.disabled = true;
          elements.status.textContent = 'Fetching available models...';
          
          const baseEndpoint = elements.endpoint.value.split('/v1/')[0];
          const response = await fetch(`${baseEndpoint}/api/tags`);
          const data = await response.json();
          
          if (!data.models) {
            throw new Error('No models found in response');
          }

          // Clear and populate model list
          elements.modelList.innerHTML = '<option value="">Select a model...</option>';
          data.models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.name;
            option.textContent = `${model.name} (${model.size})`;
            elements.modelList.appendChild(option);
          });

          // Show model list and update current selection
          elements.modelList.style.display = 'block';
          elements.modelList.value = elements.model.value;

          elements.status.textContent = `Found ${data.models.length} models`;
        } catch (error) {
          elements.status.textContent = `Error fetching models: ${error.message}`;
          elements.status.classList.add('error');
        } finally {
          elements.fetchModels.disabled = false;
        }
      });

      // Model list change handler
      elements.modelList.addEventListener('change', () => {
        if (elements.modelList.value) {
          elements.model.value = elements.modelList.value;
        }
      });

      // Cleanup on unload
      window.addEventListener('unload', () => {
        if (state.instance) {
          state.instance.destroy();
        }
      });

      // Add sidebar toggle functionality
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const rightSidebar = document.getElementById('right-sidebar');
      
      sidebarToggle.addEventListener('click', () => {
        rightSidebar.classList.toggle('collapsed');
        sidebarToggle.classList.toggle('collapsed');
      });

      // Show/hide Ollama controls on init
      const showOllama = state.implementation === 'ollama';
      elements.endpointGroup.style.display = showOllama ? 'block' : 'none';
      elements.modelGroup.style.display = showOllama ? 'block' : 'none';
    </script>
  </body>
</html>
